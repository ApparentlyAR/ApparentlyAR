<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Project - ApparentlyAR</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="global.css">
</head>

<body class="text-gray-800">
    <div id="header-container"></div>

    <main class="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a id="breadcrumb-dashboard-link" href="#"
                        class="text-sm font-medium text-gray-500 hover:text-gray-700">My Project</a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 text-gray-400 mx-1" fill="currentColor" viewBox="0 0 20 20"
                            xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd"
                                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                        <span id="breadcrumb-project-name" class="text-sm font-medium text-gray-900">Loading...</span>
                    </div>
                </li>
            </ol>
        </nav>
        <div class="flex items-center gap-4 mb-4">
            <h2 id="project-title" class="text-4xl font-bold text-gray-900">Loading Project...</h2>
            <button id="edit-project-button"
                class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="-ml-1 mr-2 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path
                        d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-6.071 7.071L4 14.172V17h2.828l6.172-6.172-2.828-2.828z" />
                </svg>
                Edit
            </button>
        </div>
        <p id="project-description" class="text-gray-600 mb-10 w-full max-w-2xl">Loading description...</p>

        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Data Panel</h3>
            <button id="download-csv-btn" class="p-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 hidden">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
            </button>
        </div>
        <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
            <div class="data-panel-table-container">
                <table id="data-table" class="min-w-full divide-y divide-gray-200">
                    </table>
            </div>
        </div>

        <!-- Show Project ID for teachers when project is published -->
        <div id="project-id-section" class="mb-8 hidden">
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                            fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <span class="font-medium">Project Code:</span>
                            <span id="project-id-display"
                                class="font-mono font-bold ml-2 bg-white px-2 py-1 rounded border"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-right">
            <button
                class="inline-flex justify-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                onclick="window.location.href='blockly-demo.html'">
                Simulate Project
            </button>
        </div>
    </main>
    <script>
        // --- Universal Dropdown Logic ---
        function closeAllDropdowns() {
            document.querySelectorAll('.project-dropdown').forEach(menu => menu.classList.add('hidden'));
        }
        function toggleUserMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('user-menu');
            const isHidden = menu.classList.contains('hidden');
            closeAllDropdowns();
            if (isHidden) menu.classList.remove('hidden');
        }
        function logout(event) {
            event.preventDefault();
            console.log("User logged out.");
            window.location.href = '/';
        }
        window.addEventListener('click', function (event) {
            if (!event.target.closest('.dropdown-toggle')) {
                closeAllDropdowns();
            }
        });

        // --- Page Setup Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // First, load the header
            fetch('header.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('header-container').innerHTML = data;
                    // Once header is loaded, run the main page logic
                    initializeApp();
                });
        });

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        async function initializeApp() {
            const projectId = getQueryParam('id');
            const role = getQueryParam('role');

            const editButton = document.getElementById('edit-project-button');
            const breadcrumbLink = document.getElementById('breadcrumb-dashboard-link');
            const headerLink = document.getElementById('header-dashboard-link');

            // 1. Set all dynamic links based on role
            const dashboardUrl = role === 'student' ? 'student-dashboard.html' : 'teacher-dashboard.html';
            if (breadcrumbLink) breadcrumbLink.href = dashboardUrl;
            if (headerLink) headerLink.href = dashboardUrl;

            // 2. Adjust UI based on role
            if (role === 'student' && editButton) {
                editButton.style.display = 'none';
            }

            // 3. Handle project ID and fetch data
            if (!projectId) {
                document.getElementById('project-title').textContent = 'Error: No Project ID Provided';
                document.getElementById('project-description').textContent = 'Please select a project from the dashboard.';
                document.getElementById('breadcrumb-project-name').textContent = 'Error';
                if (editButton) editButton.style.display = 'none';
                return;
            }

            if (role === 'teacher' && editButton) {
                editButton.onclick = function () { window.location.href = 'edit-project.html?id=' + projectId; };
            }

            try {
                const response = await fetch(`/api/projects/${projectId}`);
                if (!response.ok) throw new Error('Failed to fetch project details.');
                const project = await response.json();

                document.getElementById('breadcrumb-project-name').textContent = project.name;
                document.getElementById('project-title').textContent = project.name;
                document.getElementById('project-description').textContent = project.description || 'No description available for this project.';

                // Show project ID for teachers when project is published
                if (role === 'teacher' && project.status === 'Active') {
                    document.getElementById('project-id-display').textContent = project.id;
                    document.getElementById('project-id-section').classList.remove('hidden');
                }
                
                // Populate the data table with CSV data if available and show download button
                if (project.csvData && project.csvHeaders) {
                    // Store project data globally for download functionality
                    window.currentProjectData = project.csvData;
                    window.currentProjectHeaders = project.csvHeaders;
                    
                    populateDataTable(project.csvData, project.csvHeaders);
                    
                    // Show the download button if there's CSV data
                    document.getElementById('download-csv-btn').classList.remove('hidden');
                } else {
                    // Show a message if no CSV data is available
                    const table = document.getElementById('data-table');
                    table.innerHTML = '<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No CSV data available for this project.</td></tr>';
                    
                    // Hide download button if no CSV data
                    document.getElementById('download-csv-btn').classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading project details:', error);
                document.getElementById('breadcrumb-project-name').textContent = 'Error';
                document.getElementById('project-title').textContent = 'Error Loading Project';
                document.getElementById('project-description').textContent = `Could not load project details. ${error.message || 'Please try again.'}`;
                if (editButton) editButton.style.display = 'none';
            }
        }

        // Function to populate the data table with CSV data
        function populateDataTable(data, headers) {
            const table = document.getElementById('data-table');

            // Clear existing table content
            table.innerHTML = '';

            if (!data || data.length === 0) {
                table.innerHTML = '<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No data available.</td></tr>';
                return;
            }

            // Create header row
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            const headerRow = document.createElement('tr');

            headers.forEach(header => {
                const th = document.createElement('th');
                th.scope = 'col';
                th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = header;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create data rows
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';

                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    const cellValue = row[header] || '';
                    td.textContent = cellValue;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            table.appendChild(tbody);

            // Add horizontal scrolling if needed
            const container = document.querySelector('.data-panel-table-container');
            if (container) {
                container.style.overflowX = 'auto';
            }
        }

        // Function to create and download CSV file
        function downloadCSV(data, headers, filename) {
            // Convert data to CSV format
            let csvContent = headers.join(',') + '\n';

            data.forEach(row => {
                const rowArray = headers.map(header => {
                    let value = row[header] || '';
                    // Escape commas and quotes in values
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                        value = '"' + value.replace(/"/g, '""') + '"';
                    }
                    return value;
                });
                csvContent += rowArray.join(',') + '\n';
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', filename || 'project_data.csv');
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Add event listener for the download button
        document.getElementById('download-csv-btn').addEventListener('click', function() {
            const projectId = getQueryParam('id');
            if (projectId && window.currentProjectData && window.currentProjectHeaders) {
                const filename = `project_${projectId}_data.csv`;
                downloadCSV(window.currentProjectData, window.currentProjectHeaders, filename);
            }
        });
    </script>
</body>

</html>