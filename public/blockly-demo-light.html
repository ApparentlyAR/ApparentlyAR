<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ApparentlyAR • Simulation (Light)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Base CSS reset + light theme -->
  <style>
    :root{
      --bg:#f6f8fb;
      --panel:#ffffff;
      --ink:#1f2a37;
      --muted:#5a6b7b;
      --line:#e6e9ef;
      --accent:#2f7dd6;
      --accent-2:#5fb3ff;
      --success:#12a150;
      --warning:#f0ad00;
      --radius:14px;
      --shadow:0 2px 10px rgba(20,33,61,.06), 0 1px 3px rgba(20,33,61,.05);
      --tab:#eef5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Toolbar row under header */
    .toolbar-inner{
      max-width:1400px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;
    }
    .breadcrumb{display:flex;gap:8px;align-items:center;color:var(--muted);flex:1 1 auto;font-size:14px}
    .breadcrumb a{color:var(--muted);text-decoration:none}
    .breadcrumb .chev{opacity:.5}
    .btn{
      border:1px solid var(--line);background:var(--panel);padding:8px 12px;border-radius:12px;font-weight:600;cursor:pointer;
      transition:transform .05s ease, box-shadow .15s ease;
    }
    .btn:hover{box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.play{display:inline-flex;align-items:center;gap:8px}
    .btn.ghost{background:transparent}
    .btn.success{background:var(--success);border-color:var(--success);color:#fff}

    /* Layout: resizable left + center, collapsible right */
    .app{
      max-width:1400px;margin:16px auto 28px;display:grid;grid-template-columns: minmax(280px, 1fr) 10px minmax(420px,1.4fr) minmax(320px, 0.9fr);
      gap:0 0;height:calc(100vh - 160px);
    }
    .panel{
      background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);
      overflow:hidden;position:relative;
    }

    /* Blockly panel */
    #blocklyPanel{display:flex;flex-direction:column;}
    #blocklySearch{border:none;border-bottom:1px solid var(--line);padding:12px 14px;font-size:14px;outline:none}
    #blocklyArea{flex:1 1 auto;min-height:0}

    /* Vertical splitter between left and center */
    .splitter{
      cursor:col-resize;display:flex;align-items:center;justify-content:center;
    }
    .splitbar{
      width:2px;height:70%;background:var(--line);border-radius:2px;position:relative;
    }
    .splitbar:after{
      content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:6px;height:56px;border-radius:6px;background:var(--line);
    }

    /* Visualisation panel */
    #vizPanel{display:grid;grid-template-rows:auto 1fr;min-width:300px}
    .vizTop{
      display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 14px;background:linear-gradient(#fff, #fcfdff);
    }
    .vizTop .type{display:flex;align-items:center;gap:8px}
    select.vizType{
      appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;min-width:140px
    }
    .fileLabel{font-size:14px;color:var(--muted)}
    #vizCanvasWrap{padding:12px 14px}
    #vizCanvas{width:100%;height:100%}

    /* Data Panel (collapsible) */
    #dataShell{position:relative}
    #dataPanel{height:100%;display:grid;grid-template-rows:auto 1fr}
    .dataHead{border-bottom:1px solid var(--line);padding:10px 14px;background:linear-gradient(#fff,#fcfdff);font-weight:600}
    .dataBody{overflow:auto}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;font-size:13px;text-align:left;white-space:nowrap}
    thead th{position:sticky;top:0;background:#fff}
    /* Toggle tab – always visible on the left middle */
    .dataToggle{
      position:absolute;left:-14px;top:50%;transform:translateY(-50%);
      width:28px;height:48px;border-radius:10px 0 0 10px;background:var(--tab);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow)
    }
    .dataToggle span{font-size:18px;color:var(--accent)}
    .collapsed #dataPanel{display:none}
    .collapsed{border:1px dashed var(--line)}
    .collapsed .dataToggle{left:-14px}

    /* Bottom code viewer */
    #codeWrap{
      max-width:1400px;margin:12px auto 28px;background:var(--panel);border:1px solid var(--line);
      border-radius:var(--radius);box-shadow:var(--shadow);display:none;overflow:hidden
    }
    #codeHead{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    #codeArea{padding:12px 14px;max-height:340px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12.5px;background:#fbfcff}

    /* Utility */
    .hidden{display:none}
  </style>

  <!-- Blockly + dependencies -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Chart.js for visualisation -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Your blocks (unchanged; we only style the theme) -->
  <script src="../src/blocks/csv_import.js"></script><!-- CSV upload & stores rows/filename on Blockly.CsvImportData --> 
  <script src="../src/blocks/data_ops.js"></script>
  <script src="../src/blocks/statistics.js"></script>
  <script src="../src/blocks/to_json.js"></script>
</head>
<body>
  <!-- We load your existing header.html and then render the light toolbar under it -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <nav class="breadcrumb">
        <a href="view-project.html">My Projects</a>
        <span class="chev">›</span>
        <a href="#">[Project Name]</a>
        <span class="chev">›</span>
        <strong>Simulation</strong>
      </nav>
      <button id="btnShowCode" class="btn">Show code</button>
      <button id="btnPlay" class="btn primary play" title="Run blocks">
        ▶︎ <span>Play</span>
      </button>
      <a id="btnEnterAR" class="btn success" href="ar-demo.html">Enter AR</a>
    </div>
  </div>

  <main class="app" id="layout">
    <!-- LEFT: Blockly -->
    <section id="blocklyPanel" class="panel">
      <input id="blocklySearch" type="search" placeholder="Search blocks…" />
      <div id="blocklyArea">
        <div id="blocklyDiv" style="height:100%;width:100%"></div>
      </div>
    </section>

    <!-- Blocks Panel -->
    <section id="blocklyPanel" class="panel">
        <input id="blocklySearch" type="search" placeholder="Search blocks…" />
      <div id="blocklyArea">
        <!-- Blockly Workspace -->
        <div id="blocklyDiv" style="height:100%;width:100%"></div>
      </div>

      <!-- Hidden Blockly Toolbox -->
      <xml id="toolbox" style="display: none">
        <category name="Logic" colour="210">
          <block type="controls_if"></block>
          <block type="logic_compare"></block>
          <block type="logic_operation"></block>
          <block type="logic_negate"></block>
          <block type="logic_boolean"></block>
        </category>
        <category name="Loops" colour="120">
          <block type="controls_repeat_ext"></block>
          <block type="controls_whileUntil"></block>
        </category>
        <category name="Math" colour="230">
          <block type="math_number"></block>
          <block type="math_arithmetic"></block>
          <block type="math_single"></block>
          <block type="math_round"></block>
          <block type="math_on_list"></block>
        </category>
        <category name="Text" colour="160">
          <block type="text"></block>
          <block type="text_print"></block>
        </category>
        <category name="Lists" colour="260">
          <block type="lists_create_with"></block>
          <block type="lists_getIndex"></block>
          <block type="lists_setIndex"></block>
          <block type="lists_length"></block>
        </category>
        <category name="Variables" colour="330" custom="VARIABLE"></category>
        <category name="Functions" colour="290" custom="PROCEDURE"></category>
        <category name="Data" colour="20">
          <block type="csv_import"></block>
          <block type="to_json">
            <value name="VALUE">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="filter_data">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="sort_data">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="select_columns">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="group_by">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="calculate_column">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
          <block type="drop_empty">
            <value name="DATA">
              <block type="csv_import"></block>
            </value>
          </block>
        </category>
      </xml>
    </section>

    <!-- SPLITTER -->
    <div id="splitter" class="splitter"><div class="splitbar"></div></div>

    <!-- CENTER: Visualisation -->
    <section id="vizPanel" class="panel">
      <div class="vizTop">
        <div class="type">
          <label for="vizType" style="font-weight:600">Type</label>
          <select id="vizType" class="vizType">
            <option value="bar">Bar Chart</option>
            <option value="line" selected>Line Chart</option>
            <option value="scatter">Scatter</option>
          </select>
        </div>
        <div class="fileLabel" id="fileLabel">No file chosen</div>
      </div>
      <div id="vizCanvasWrap">
        <canvas id="vizCanvas"></canvas>
      </div>
    </section>

    <!-- RIGHT: Data -->
    <aside id="dataShell" class="panel">
      <div class="dataToggle" id="dataToggle" title="Collapse / expand data panel">
        <span>›</span>
      </div>
      <div id="dataPanel">
        <div class="dataHead">Data Panel</div>
        <div class="dataBody">
          <table id="dataTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <!-- Bottom code viewer -->
  <section id="codeWrap" aria-hidden="true">
    <div id="codeHead">
      <strong>Generated JavaScript</strong>
      <button id="btnCloseCode" class="btn ghost">Close</button>
    </div>
    <pre id="codeArea"></pre>
  </section>

  <!-- Optional existing toolbox: keep your own XML here; we won’t change content -->
  <!-- If you already inject via components.js, this can stay empty. -->
  <xml id="toolbox" style="display:none"></xml>

  <script>
    // Load header.html into <header>
    (async () => {
      try {
        const r = await fetch('header.html'); if(!r.ok) throw 0;
        document.getElementById('hdr').innerHTML = await r.text();
      } catch {}
    })();

    // -------- Blockly LIGHT THEME (only colours changed) ----------
    const LIGHT_THEME = Blockly.Theme.defineTheme('apparentlyLight', {
      'base': Blockly.Themes.Classic,
      'componentStyles': {
        toolboxForegroundColour: '#354355',
        toolboxBackgroundColour: '#eef3fa',
        flyoutBackgroundColour: '#ffffff',
        flyoutForegroundColour: '#4c5d70',
        flyoutOpacity: 1,
        insertionMarkerOpacity: 0.3,
        scrollbarColour: '#cdd6e1'
      },
      'categoryStyles': {               // we leave categories as-is; only provide gentle hues
        logic_category:    { colour: '#6aa84f' },
        loops_category:    { colour: '#3d85c6' },
        math_category:     { colour: '#674ea7' },
        text_category:     { colour: '#a64d79' },
        lists_category:    { colour: '#bf9000' },
        variables_category:{ colour: '#2d8cf0' },
        functions_category:{ colour: '#0b7a75' },
        data_category:     { colour: '#ff8a3d' },
        misc_category:     { colour: '#708090' }
      },
      'blockStyles': {
        logic_blocks:  { colourPrimary: '#6aa84f' },
        loop_blocks:   { colourPrimary: '#3d85c6' },
        math_blocks:   { colourPrimary: '#674ea7' },
        text_blocks:   { colourPrimary: '#a64d79' },
        list_blocks:   { colourPrimary: '#bf9000' },
        variable_blocks:{ colourPrimary: '#2d8cf0' },
        procedure_blocks:{ colourPrimary: '#0b7a75' },
        // data / stats / ops blocks provided by your files keep their original block colours
      }
    });

    // -------- Inject Blockly ----------
    const toolbox = document.getElementById('toolbox'); // use your existing toolbox if present
    const workspace = Blockly.inject('blocklyDiv', {
      theme: LIGHT_THEME,
      grid: { spacing: 20, length: 3, colour: '#e9eef5', snap: true },
      zoom: { controls: true, wheel: true, startScale: 0.95, maxScale: 2.0, minScale: 0.5, pinch: true },
      move: { wheel: true, drag: true, scrollbars: true },
      renderer: 'zelos',
      toolbox: toolbox && toolbox.childNodes.length ? toolbox : undefined
    });

    // Search filter for flyout
    document.getElementById('blocklySearch').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      const tb = workspace.getToolbox();
      if(!tb) return;
      tb.refreshSelection(); // ensures fresh state
      if(!q){ tb.clearSearch(); return; }
      tb.search(q);
    });

    // Preserve blocks across reloads (simple)
    const STORAGE_KEY = 'apparently.blockly.workspace';
    try{
      const json = localStorage.getItem(STORAGE_KEY);
      if(json){ Blockly.serialization.workspaces.load(JSON.parse(json), workspace); }
      workspace.addChangeListener(()=>{
        const data = Blockly.serialization.workspaces.save(workspace);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      });
    }catch{}

    // -------- Resizable left/center via splitter ----------
    (function(){
      const layout = document.getElementById('layout');
      const splitter = document.getElementById('splitter');
      let dragging = false, startX = 0, startCol1 = 0, startCol3 = 0;

      splitter.addEventListener('mousedown', (e)=>{
        dragging = true; startX = e.clientX;
        const cs = getComputedStyle(layout).gridTemplateColumns.split(' ');
        startCol1 = parseFloat(cs[0]); // px because container has fixed max-width
        startCol3 = parseFloat(cs[2]);
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX;
        const col1 = Math.max(280, startCol1 + dx);
        const col3 = Math.max(420, startCol3 - dx);
        layout.style.gridTemplateColumns = `${col1}px 10px ${col3}px minmax(320px, 0.9fr)`;
        Blockly.svgResize(workspace);
      });
      window.addEventListener('mouseup', ()=>{
        if(!dragging) return; dragging = false; document.body.style.cursor = '';
        Blockly.svgResize(workspace);
      });
    })();

    // -------- Data panel toggle (tab always stays visible) ----------
    (function(){
      const shell = document.getElementById('dataShell');
      const tab = document.getElementById('dataToggle');
      let open = true;
      const updateIcon = ()=> tab.firstElementChild.textContent = open ? '‹' : '›';
      tab.addEventListener('click', ()=>{
        open = !open;
        shell.classList.toggle('collapsed', !open);
        updateIcon();
        Blockly.svgResize(workspace);
      });
      updateIcon();
    })();

    // -------- Visualisation (Chart.js) ----------
    let chart;
    const ctx = document.getElementById('vizCanvas').getContext('2d');

    function renderChart(rows){
      const type = document.getElementById('vizType').value || 'line';
      if(chart){ chart.destroy(); chart = null; }
      const columns = rows && rows.length ? Object.keys(rows[0]) : [];
      const numeric = columns.filter(c => rows.some(r => !isNaN(parseFloat(r[c]))));
      const xKey = columns[0] || 'Row';
      const yKey = numeric[0] || null;

      const labels = rows.map((r,i)=> r[xKey] ?? i+1);
      const data = yKey ? rows.map(r => parseFloat(r[yKey])) : [];

      chart = new Chart(ctx, {
        type: (type==='scatter' ? 'scatter' : type),
        data: {
          labels: (type==='scatter' ? undefined : labels),
          datasets: [{
            label: yKey || 'Count',
            data: (type==='scatter')
              ? rows.map((r,i)=> ({x:i+1, y: yKey ? parseFloat(r[yKey]) : 1}))
              : data.length ? data : rows.map(()=>1),
            tension: .25,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins:{ legend:{ display:true } },
          scales: (type==='scatter'
            ? { x:{ title:{display:true,text:'Index'} }, y:{ title:{display:true,text:yKey||'Value'} } }
            : {})
        }
      });
    }

    // -------- Data table ----------
    function renderTable(rows){
      const thead = document.querySelector('#dataTable thead');
      const tbody = document.querySelector('#dataTable tbody');
      thead.innerHTML = tbody.innerHTML = '';
      if(!rows || !rows.length) return;
      const cols = Object.keys(rows[0]);
      thead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
      const MAX = 500; // safety for huge CSVs
      const frag = document.createDocumentFragment();
      rows.slice(0,MAX).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = cols.map(c => `<td>${(r[c] ?? '')}</td>`).join('');
        frag.appendChild(tr);
      });
      tbody.appendChild(frag);
    }

    // -------- Play (execute blocks) ----------
    const codeArea = document.getElementById('codeArea');
    async function runBlocks(){
      // generate code from workspace
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      codeArea.textContent = code;

      // filename label (from your CSV block state)
      const fname = (Blockly.CsvImportData && Blockly.CsvImportData.filename) ? Blockly.CsvImportData.filename : 'No file chosen';
      document.getElementById('fileLabel').textContent = fname;

      // Execute generated code safely (support async snippets created by your blocks)
      let resultRows = null;
      try{
        // eslint-disable-next-line no-new-func
        const f = new Function(`return (async()=>{ ${code}; return (typeof result!=='undefined'?result:(window.Blockly && Blockly.CsvImportData && Blockly.CsvImportData.data)||[]); })()`);
        resultRows = await f();
      }catch(err){
        console.error(err);
        alert('There was an error running your blocks. Check the console for details.');
        resultRows = (window.Blockly && Blockly.CsvImportData && Blockly.CsvImportData.data) || [];
      }

      if(!Array.isArray(resultRows)){
        // Some of your blocks return numbers/stats; if so, wrap as rows for charting
        resultRows = [{ Value: resultRows }];
      }

      renderChart(resultRows);
      renderTable(resultRows);
    }

    // Buttons
    document.getElementById('btnPlay').addEventListener('click', runBlocks);
    document.getElementById('btnShowCode').addEventListener('click', ()=>{
      const wrap = document.getElementById('codeWrap');
      const open = wrap.style.display !== 'block';
      if(open){
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        codeArea.textContent = code;
      }
      wrap.style.display = open ? 'block' : 'none';
    });
    document.getElementById('btnCloseCode').addEventListener('click', ()=>{
      document.getElementById('codeWrap').style.display = 'none';
    });

    // Re-render when chart type changes
    document.getElementById('vizType').addEventListener('change', ()=>{
      const rows = (window.Blockly && Blockly.CsvImportData && Blockly.CsvImportData.data) || [];
      renderChart(Array.isArray(rows) ? rows : []);
    });

    // Repaint Blockly on window resize
    window.addEventListener('resize', ()=> Blockly.svgResize(workspace));

    // Integrate with your CSV block’s autofill to refresh table upon upload
    // (csv_import.js already sets Blockly.CsvImportData.*)
    window.addEventListener('message', (e)=>{
      if(e.data === 'csv-updated'){ // optional hook if you emit a message elsewhere
        const rows = (Blockly.CsvImportData && Blockly.CsvImportData.data) || [];
        document.getElementById('fileLabel').textContent = Blockly.CsvImportData.filename || 'No file chosen';
        renderTable(rows);
        renderChart(rows);
      }
    });
  </script>
</body>
</html>
