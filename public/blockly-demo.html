<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" href="favicon.ico" />
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>ApparentlyAR - Simulation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config for the new light theme
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: '#F8F9FA', // Light grey background
            panel: '#FFFFFF',      // White panels
            border: '#E5E7EB',    // Light grey border
            text: '#1F2937',        // Dark text
            muted: '#6B7280',     // Grey for muted text
            primary: '#22C55E',   // Vibrant green for play button
            'primary-hover': '#16A34A',
            secondary: '#4F46E5', // Accent color for Blockly
          },
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif'],
          }
        },
      },
    };
  </script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <style>
    /* Custom styles for the new layout */
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #F8F9FA;
      user-select: none; /* Prevent text selection during drag */
    }

    #main-content-grid {
        display: grid;
        grid-template-columns: 320px 8px 1fr 8px 360px; /* Panels and resizers */
    }
    
    /* This class will be toggled to provide smooth animation only when not dragging */
    .grid-transition {
        transition: grid-template-columns 0.3s ease-in-out;
    }

    /* Resizer handle styles */
    .resizer {
      background: #F8F9FA;
      cursor: col-resize;
      z-index: 10;
      position: relative;
    }
    .resizer:hover::after, .resizer.is-dragging::after {
      content: '';
      position: absolute;
      top: 0;
      left: 3px;
      width: 2px;
      height: 100%;
      background: #4F46E5; /* secondary color */
    }
    
    /* Allow panels to shrink to zero */
    #blocks-panel, #data-panel {
        min-width: 0;
    }

    #toggle-data-panel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 20;
        transition: right 0.3s ease-in-out;
    }

    #main-content-grid.data-closed #data-panel {
        overflow: hidden;
    }

    /* Code panel toggle transition */
    #code-panel {
      transition: height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      height: 200px;
      opacity: 1;
      overflow: hidden;
    }
    #code-panel.hidden {
      height: 0;
      opacity: 0;
      padding: 0;
    }
    #code-panel pre {
        background-color: #F3F4F6;
        border: 1px solid #E5E7EB;
        color: #111827;
    }

    /* Tweak Blockly's appearance */
    .blocklyToolboxDiv {
        background-color: #F3F4F6;
        border-right: 1px solid #E5E7EB;
        overflow-y: hidden !important; /* Remove toolbox category scrollbar */
    }
    
    .blocklyFlyout {
      overflow: hidden !important;
    }
    
    .blocklyFlyoutScrollbar {
      display: none !important;
    }

    /* Ensure proper sizing for Blockly workspace */
    .blocklySvg {
      display: block;
    }

    /* Fix for scrollbars appearing when not needed */
    .blocklyToolboxDiv::-webkit-scrollbar {
      display: none;
    }
    
    .blocklyToolboxDiv {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .blocklyTreeRow.blocklyTreeSelected {
        background-color: #E0E7FF !important;
    }
     .blocklyTreeRow:not(.blocklyTreeSelected):hover {
        background-color: #EFF6FF !important;
    }
    
    /* Fix for data panel header */
    #data-panel-content th {
        position: sticky;
        top: 0;
        z-index: 1; /* Ensures header is above scrolling content */
        background-color: #F9FAFB; /* Added background to fix the "hole" */
    }
  </style>
</head>

<body class="text-text bg-background">

  <div id="header-container"></div>

  <div class="flex flex-col h-screen">
    <!-- Top Bar -->
    <header class="bg-[#f8fafc] border-b border-border shadow-sm flex-shrink-0">
      <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center space-x-2 text-sm">
              <a href="#" class="text-muted hover:text-text">My Project</a>
              <span class="text-gray-300">></span>
              <a href="#" class="text-muted hover:text-text">Visualisation 1</a>
              <span class="text-gray-300">></span>
              <span class="text-text font-medium">Simulation</span>
            </nav>
          </div>
          <div class="flex items-center gap-3">
             <button onclick="executeBlocklyCode()"
              class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-3 rounded-lg flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </button>
            <button onclick="window.location.href='ar-demo.html'"
              class="bg-panel border border-border text-white text-text hover:bg-yellow-500 bg-yellow-400 font-medium py-2 px-4 rounded-lg transition-colors">
              Enter AR
            </button>
             <button id="show-code-btn" onclick="toggleCodePanel()"
              class="bg-panel border border-border text-white text-text hover:bg-red-300 bg-red-400 font-medium py-2 px-4 rounded-lg transition-colors">
              Show code
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 relative overflow-hidden">
      <main id="main-content-grid" class="h-full">
        <!-- Blocks Panel -->
        <aside id="blocks-panel" class="flex flex-col bg-panel overflow-hidden">
          <div class="p-2 border-b border-border">
            <input class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-secondary"
              placeholder="Search blocks..." />
          </div>
          <div id="blocklyDiv" class="w-full h-full flex-1"></div>
        </aside>
  
        <!-- Left Resizer -->
        <div class="resizer" id="resizer-left"></div>

        <!-- Middle Panel: Visualization -->
        <section id="viz-panel" class="flex flex-col bg-background overflow-hidden">
          <div class="flex items-center justify-between gap-2 p-2.5 border-b border-border bg-panel flex-shrink-0">
              <span id="csv-filename" class="text-sm font-medium text-text">No file loaded</span>
              <div class="flex items-center gap-2">
                  <select id="chart-type-select" class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1 focus:outline-none focus:ring-2 focus:ring-secondary">
                  </select>
              </div>
          </div>
          <div class="flex-1 p-4 min-h-0">
               <div id="react-chart-container" class="w-full h-full bg-panel rounded-lg border border-border flex items-center justify-center text-muted p-4 relative">
                  Visualization will appear here when blocks are executed
              </div>
          </div>
        </section>

        <!-- Right Resizer -->
        <div class="resizer" id="resizer-right"></div>
  
        <!-- Right Panel: Data -->
        <aside id="data-panel" class="bg-panel flex flex-col overflow-hidden">
            <div class="flex items-center justify-between p-2.5 border-b border-border">
              <strong class="text-sm font-medium">Data Panel</strong>
            </div>
          <div id="data-panel-content" class="overflow-auto flex-1 p-2">
              <div class="text-sm text-muted text-center py-8">
              Data will appear here when imported.
              </div>
          </div>
        </aside>
      </main>

      <!-- Toggle button -->
      <button id="toggle-data-panel-btn" onclick="toggleDataPanel()" class="bg-panel hover:bg-gray-100 text-muted hover:text-text rounded-full shadow-md w-6 h-10 flex items-center justify-center border border-border">
        <svg id="toggle-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>

    </div>

     <!-- Bottom Panel: Code Output -->
    <footer id="code-panel" class="bg-panel border-t border-border p-2 hidden flex-shrink-0">
      <pre id="output-root" class="h-full w-full rounded-md p-2 text-sm font-mono overflow-auto"></pre>
    </footer>

  </div>

  <!-- Blockly Toolbox Definition -->
  <xml id="toolbox" style="display: none">
    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="120">
      <block type="controls_repeat_ext"></block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
    </category>
    <category name="Text" colour="160">
      <block type="text"></block>
      <block type="text_print"></block>
    </category>
    <category name="Lists" colour="260">
      <block type="lists_create_with"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_length"></block>
    </category>
    <category name="Variables" colour="330" custom="VARIABLE"></category>
    <category name="Functions" colour="290" custom="PROCEDURE"></category>
    <category name="Data" colour="20">
      <block type="csv_import"></block>
      <block type="to_json">
        <value name="VALUE">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="filter_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="sort_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="select_columns">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="group_by">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_column">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="drop_empty">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
    </category>
  </xml>

  <!-- BLOCK DEFINITIONS AND GENERATORS SCRIPT (minified for brevity) -->
  <script>
    // --- Universal Dropdown Logic ---
    function closeAllDropdowns() {
      document.querySelectorAll('.project-dropdown').forEach(menu => menu.classList.add('hidden'));
    }
    function toggleUserMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('user-menu');
      const isHidden = menu.classList.contains('hidden');
      closeAllDropdowns();
      if (isHidden) menu.classList.remove('hidden');
    }
    function logout(event) {
      event.preventDefault();
      console.log("User logged out.");
      window.location.href = '/';
    }
    window.addEventListener('click', function (event) {
      if (!event.target.closest('.dropdown-toggle')) {
        closeAllDropdowns();
      }
    });

    // --- Page Header Logic ---
    document.addEventListener('DOMContentLoaded', () => {
      fetch('header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header-container').innerHTML = data;
        // Once header is loaded, run the main page logic
        initializeApp();
      });
    });
    
    // === START: csv_import.js (Bug Fix Applied) ===
    (function(){if(typeof Blockly==='undefined')return;Blockly.defineBlocksWithJsonArray([{"type":"csv_import","message0":"import CSV %1 %2","args0":[{"type":"field_label","name":"CSV_FILENAME","text":""},{"type":"field_file_button","name":"CSV_UPLOAD"}],"output":"Dataset","colour":230,"tooltip":"Import a CSV file."}]);class FieldFileButton extends Blockly.Field{constructor(val,valid){super(val,valid);this.SERIALIZABLE=!0;this.filename_="No file chosen"}static fromJson(opts){return new FieldFileButton(opts.value)}showEditor_(){this.fileInput_=document.createElement("input");this.fileInput_.type="file";this.fileInput_.accept=".csv";this.fileInput_.style.display="none";this.fileInput_.addEventListener("change",e=>{const file=e.target.files[0];if(file){this.filename_=file.name;const field=this.sourceBlock_.getField("CSV_FILENAME");if(field)field.setValue(file.name);const reader=new FileReader;reader.onload=event=>{Papa.parse(event.target.result,{header:!0,skipEmptyLines:!0,complete:results=>{Blockly.CsvImportData.data=results.data;Blockly.CsvImportData.filename=file.name;window.dispatchEvent(new CustomEvent("csvDataChanged",{detail:{filename:file.name}}))}})};reader.readAsText(file);this.sourceBlock_.render()}},!1);this.fileInput_.click()}render_(){super.render_();const group=this.getSvgRoot();if(!group)return;if(this.button_)this.button_.remove();this.button_=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");this.button_.setAttribute("width",24);this.button_.setAttribute("height",24);this.button_.innerHTML='<button style="height:24px;width:24px;border-radius:50%;border:none;background:#4F46E5;color:white;font-size:16px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;">+</button>';const btn=this.button_.querySelector("button");const stopAll=e=>{e.preventDefault();e.stopPropagation()};btn.addEventListener("mousedown",stopAll);btn.addEventListener("click",e=>{stopAll(e);this.showEditor_()});group.appendChild(this.button_)}saveState(){return{filename:this.filename_}}loadState(state){this.filename_=state.filename||"No file chosen";if(this.sourceBlock_&&this.filename_!=="No file chosen"){const field=this.sourceBlock_.getField("CSV_FILENAME");if(field)field.setValue(this.filename_)}}}Blockly.fieldRegistry.register("field_file_button",FieldFileButton);Blockly.CsvImportData={data:null,filename:null};Blockly.JavaScript.forBlock={csv_import:()=>["(window.Blockly&&window.Blockly.CsvImportData?window.Blockly.CsvImportData.data:null)",Blockly.JavaScript.ORDER_ATOMIC]}})();
    (function(){function getCols(){const d=window.Blockly&&window.Blockly.CsvImportData&&window.Blockly.CsvImportData.data;return d&&Array.isArray(d)&&d.length>0?Object.keys(d[0]):[]}function updateField(field,multi){if(field&&field.setOptions){const cols=getCols();if(cols.length>0){const opts=multi?[["All columns","all"],...cols.map(c=>[c,c])]:cols.map(c=>[c,c]);field.setOptions(opts)}}}function init(){Blockly.defineBlocksWithJsonArray([{"type":"filter_data","message0":"filter %1 where %2 %3 %4","args0":[{"type":"input_value","name":"DATA","check":"Dataset"},{"type":"field_dropdown","name":"COLUMN","options":[["column","column"]]},{"type":"field_dropdown","name":"OPERATOR","options":[["equals","="],["not equals","!="],["greater than",">"],["less than","<"],["contains","contains"]]},{"type":"field_input","name":"VALUE","text":"value"}],"output":"Dataset","colour":20},{"type":"sort_data","message0":"sort %1 by %2 %3","args0":[{"type":"input_value","name":"DATA","check":"Dataset"},{"type":"field_dropdown","name":"COLUMN","options":[["column","column"]]},{"type":"field_dropdown","name":"DIRECTION","options":[["ascending","asc"],["descending","desc"]]}],"output":"Dataset","colour":20},{"type":"select_columns","message0":"select columns %1 from %2","args0":[{"type":"field_dropdown","name":"COLUMNS","options":[["col1,col2","col1,col2"]]},{"type":"input_value","name":"DATA","check":"Dataset"}],"output":"Dataset","colour":20,"tooltip":"Select specific columns."},{"type":"group_by","message0":"group %1 by %2 and %3 %4 as %5","args0":[{"type":"input_value","name":"DATA","check":"Dataset"},{"type":"field_dropdown","name":"GROUP_COLUMN","options":[["group_column","group_column"]]},{"type":"field_dropdown","name":"AGGREGATION","options":[["sum","sum"],["average","average"],["count","count"],["min","min"],["max","max"]]},{"type":"field_dropdown","name":"AGG_COLUMN","options":[["value_column","value_column"]]},{"type":"field_input","name":"ALIAS","text":"result"}],"output":"Dataset","colour":20,"tooltip":"Group data and aggregate."},{"type":"calculate_column","message0":"calculate %1 as %2 from %3","args0":[{"type":"field_input","name":"EXPRESSION","text":"col1 + col2"},{"type":"field_input","name":"NEW_COLUMN","text":"new_column"},{"type":"input_value","name":"DATA","check":"Dataset"}],"output":"Dataset","colour":20,"tooltip":"Calculate a new column."},{"type":"drop_empty","message0":"drop empty rows in %1 from %2","args0":[{"type":"field_dropdown","name":"COLUMN","options":[["column","column"]]},{"type":"input_value","name":"DATA","check":"Dataset"}],"output":"Dataset","colour":20}]);if(Blockly.JavaScript){window.BlocklyNormalizeData=d=>Array.isArray(d)?d:d&&Array.isArray(d.data)?d.data:"string"==typeof d?JSON.parse(d):[];const getCode=b=>Blockly.JavaScript.valueToCode(b,"DATA",Blockly.JavaScript.ORDER_NONE)||"Blockly.CsvImportData.data";Blockly.JavaScript.forBlock.filter_data=b=>{const d=getCode(b),c=b.getFieldValue("COLUMN"),o=b.getFieldValue("OPERATOR"),v=b.getFieldValue("VALUE");return[`((${d}||[]).filter(r=>String(r['${c}']).includes('${v}')))`,Blockly.JavaScript.ORDER_FUNCTION_CALL]};Blockly.JavaScript.forBlock.sort_data=b=>{const d=getCode(b),c=b.getFieldValue("COLUMN"),dir=b.getFieldValue("DIRECTION");return[`([...(${d}||[])].sort((a,b)=>{const va=a['${c}'],vb=b['${c}'];return va<vb?${"asc"===dir?-1:1}:va>vb?${"asc"===dir?1:-1}:0}))`,Blockly.JavaScript.ORDER_FUNCTION_CALL]};Blockly.JavaScript.forBlock.drop_empty=b=>{const d=getCode(b),c=b.getFieldValue("COLUMN");return[`((${d}||[]).filter(r=>r['${c}']!=null&&r['${c}']!==""))`,Blockly.JavaScript.ORDER_FUNCTION_CALL]};}}typeof Blockly<"u"&&Blockly.JavaScript?init():setTimeout(init,10);function autoFill(b){if(b&&b.type){const t=b.type,cols=getCols();if(0!==cols.length)switch(t){case"filter_data":updateField(b.getField("COLUMN"));break;case"sort_data":updateField(b.getField("COLUMN"));break;case"drop_empty":updateField(b.getField("COLUMN"))}}}function updateAll(){if(typeof Blockly>"u"||!Blockly.getMainWorkspace)return;const ws=Blockly.getMainWorkspace();ws&&ws.getAllBlocks().forEach(b=>autoFill(b))}window.BlocklyAutofill={updateAllBlocksWithAutofill:updateAll}})();
    (function(){if(typeof Blockly<"u"){Blockly.defineBlocksWithJsonArray([{"type":"to_json","message0":"to JSON %1","args0":[{"type":"input_value","name":"VALUE","check":"Dataset"}],"output":"String","colour":20}]);if(Blockly.JavaScript)Blockly.JavaScript.forBlock.to_json=b=>[`JSON.stringify(${Blockly.JavaScript.valueToCode(b,"VALUE",Blockly.JavaScript.ORDER_NONE)||"null"},null,2)`,Blockly.JavaScript.ORDER_FUNCTION_CALL]}})();
  

  <!-- MAIN APPLICATION SCRIPT -->
    let workspace;
    let chartInstance;
    
    // Blockly theme
    const lightTheme = Blockly.Theme.defineTheme('lightTheme', {
      'base': Blockly.Themes.Classic,
      'componentStyles': {
        'workspaceBackgroundColour': '#FFFFFF', 'toolboxBackgroundColour': '#F3F4F6',
        'toolboxForegroundColour': '#1F2937', 'flyoutBackgroundColour': '#FFFFFF',
        'flyoutForegroundColour': '#1F2937', 'scrollbarColour': '#D1D5DB',
      },
    });

    // Initialize Blockly Workspace
    workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: { spacing: 25, length: 2, colour: '#F1F5F9', snap: true },
      zoom: { controls: true, wheel: true, startScale: 0.8, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
      move: { scrollbars: false, drag: true, wheel: true },
      trashcan: true,
      theme: lightTheme,
      renderer: 'zelos'
    });
    
    // --- UI Interaction Functions ---
    const mainGrid = document.getElementById('main-content-grid');
    const toggleBtn = document.getElementById('toggle-data-panel-btn');

    function updateToggleButtonPosition() {
        const dataPanel = document.getElementById('data-panel');
        const resizerRight = document.getElementById('resizer-right');
        const isClosed = mainGrid.classList.contains('data-closed');
        if (isClosed) {
            toggleBtn.style.right = '0px';
        } else {
            toggleBtn.style.right = `${dataPanel.offsetWidth + resizerRight.offsetWidth}px`;
        }
    }
    
    function toggleDataPanel() {
        const isClosing = !mainGrid.classList.contains('data-closed');
        if (isClosing) {
            // Store the current width before closing
            dataPanelWidth = document.getElementById('data-panel').offsetWidth;
        }

        mainGrid.classList.add('grid-transition');
        mainGrid.classList.toggle('data-closed');
        
        const blocksPanelWidth = document.getElementById('blocks-panel').offsetWidth;
        const currentDataWidth = isClosing ? 0 : dataPanelWidth;
        mainGrid.style.gridTemplateColumns = `${blocksPanelWidth}px 8px 1fr 8px ${currentDataWidth}px`;

        document.getElementById('toggle-icon').innerHTML = isClosing 
            ? '<polyline points="15 18 9 12 15 6"></polyline>' // Left arrow
            : '<polyline points="9 18 15 12 9 6"></polyline>';  // Right arrow
        
        mainGrid.addEventListener('transitionend', () => {
            window.dispatchEvent(new Event('resize')); 
            mainGrid.classList.remove('grid-transition');
        }, { once: true });
    }

    function toggleCodePanel() {
        document.getElementById('code-panel').classList.toggle('hidden');
    }
    
    // --- Blockly Code Execution ---
    async function executeBlocklyCode() {
      try {
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        updateCodeOutput(code);
        if (!code.trim()) return;

        const asyncWrapper = `(async () => { return ${code} })();`;
        let result = await eval(asyncWrapper);
        if (result === undefined && Blockly.CsvImportData) {
            result = Blockly.CsvImportData.data;
        }
        renderDataPanel(result);
        renderDataVisualization(result);
      } catch (e) {
        console.error('Error executing Blockly code:', e);
        updateCodeOutput(`Error: ${e.message}`);
      }
    }
    
    function updateCodeOutput(content) {
        document.getElementById('output-root').textContent = content || "Workspace is empty.";
    }

    // --- Data & Visualization Rendering ---
    function renderDataPanel(data) {
        const container = document.getElementById('data-panel-content');
        const dataToRender = data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : null);
        if (!dataToRender || dataToRender.length === 0) {
            container.innerHTML = `<div class="text-sm text-muted text-center p-4">No data to display.</div>`;
            return;
        }
        const headers = Object.keys(dataToRender[0]);
        let tableHtml = `<table class="min-w-full text-sm"><thead><tr>`;
        headers.forEach(h => { tableHtml += `<th class="px-2 py-2 text-left font-medium text-muted">${h}</th>`; });
        tableHtml += `</tr></thead><tbody class="divide-y divide-border">`;
        dataToRender.slice(0, 100).forEach(row => {
            tableHtml += `<tr>`;
            headers.forEach(h => { tableHtml += `<td class="px-2 py-1 whitespace-nowrap overflow-hidden text-ellipsis">${row[h] || ''}</td>`; });
            tableHtml += `</tr>`;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }

    function renderDataVisualization(data) {
        const container = document.getElementById('react-chart-container');
        const dataToRender = data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : null);
        if (chartInstance) chartInstance.destroy();
        if (!dataToRender || dataToRender.length === 0) {
            container.innerHTML = 'Run blocks with data to generate a visualization.';
            return;
        }
        container.innerHTML = '<canvas id="chart-canvas"></canvas>';
        const ctx = document.getElementById('chart-canvas').getContext('2d');
        const chartType = document.getElementById('chart-type-select').value;
        const { labels, datasets } = prepareChartData(dataToRender);
        chartInstance = new Chart(ctx, {
            type: chartType,
            data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }

    function prepareChartData(data) {
        if (!data || data.length === 0) return { labels: [], datasets: [] };
        const headers = Object.keys(data[0]);
        let labelColumn = headers.find(h => isNaN(parseFloat(data[0][h]))) || headers[0];
        let dataColumns = headers.filter(h => h !== labelColumn && !isNaN(parseFloat(data[0][h])));
        if(dataColumns.length === 0 && headers.length > 1) dataColumns.push(headers[1]);

        const labels = data.map(row => row[labelColumn]);
        const datasets = dataColumns.map((col, index) => {
             const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EC4899', '#8B5CF6'];
            return {
                label: col,
                data: data.map(row => parseFloat(row[col])),
                backgroundColor: colors[index % colors.length] + '80',
                borderColor: colors[index % colors.length],
                borderWidth: 1
            }
        });
        return { labels, datasets };
    }
    
    // --- Panel Resizing Logic ---
    let blocksPanelWidth = 320;
    let dataPanelWidth = 360;

    function initializeResizing() {
        const resizerLeft = document.getElementById('resizer-left');
        const resizerRight = document.getElementById('resizer-right');

        function makeResizable(resizer) {
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                let isDragging = true;
                resizer.classList.add('is-dragging');
                document.body.style.cursor = 'col-resize';
                
                const onMouseMove = (moveEvent) => {
                    if (!isDragging) return;
                    
                    const rect = mainGrid.getBoundingClientRect();
                    const isDataPanelClosed = mainGrid.classList.contains('data-closed');

                    if (resizer === resizerLeft) {
                        blocksPanelWidth = Math.max(250, moveEvent.clientX - rect.left);
                    } else if (!isDataPanelClosed) {
                        dataPanelWidth = Math.max(250, rect.right - moveEvent.clientX);
                    }
                    
                    const currentDataWidth = isDataPanelClosed ? 0 : dataPanelWidth;
                    mainGrid.style.gridTemplateColumns = `${blocksPanelWidth}px 8px 1fr 8px ${currentDataWidth}px`;
                    
                    window.dispatchEvent(new Event('resize'));
                };

                const onMouseUp = () => {
                    isDragging = false;
                    resizer.classList.remove('is-dragging');
                    document.body.style.cursor = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }
        makeResizable(resizerLeft);
        makeResizable(resizerRight);
    }

    // --- App Initialization ---
    function initializeApp() {
        const chartTypes = ['bar', 'line', 'pie', 'doughnut', 'radar', 'polarArea'];
        document.getElementById('chart-type-select').innerHTML = chartTypes.map(t => `<option value="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');

        window.addEventListener('csvDataChanged', (e) => {
            document.getElementById('csv-filename').textContent = e.detail.filename || 'No file loaded';
            renderDataPanel();
            if (window.BlocklyAutofill) window.BlocklyAutofill.updateAllBlocksWithAutofill();
        });

        workspace.addChangeListener((event) => {
          // Fix for toolbox not closing
          if (event.type === Blockly.Events.BLOCK_DRAG && !event.isStart || event.type === Blockly.Events.SELECTED) {
             if (workspace.getToolbox() && workspace.getToolbox().getFlyout()) {
               workspace.getToolbox().getFlyout().hide();
             }
          }
        });

        window.addEventListener('resize', () => {
          if(workspace) Blockly.svgResize(workspace);
          if(chartInstance) chartInstance.resize();
          updateToggleButtonPosition();
        });

        initializeResizing();
        updateToggleButtonPosition();
    }
    
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>



