<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ApparentlyAR • Simulation (Light)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f6f8fb; --panel:#fff; --ink:#1f2a37; --muted:#5a6b7b; --line:#e6e9ef;
      --accent:#2f7dd6; --success:#12a150; --radius:14px;
      --shadow:0 2px 10px rgba(20,33,61,.06), 0 1px 3px rgba(20,33,61,.05);
      --tab:#eef5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

    /* Top toolbar only (no site header) */
    .toolbar{background:var(--panel);box-shadow:var(--shadow);position:sticky;top:0;z-index:50;border-bottom:1px solid var(--line)}
    .toolbar-inner{max-width:1400px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center}
    .breadcrumb{display:flex;gap:8px;align-items:center;color:var(--muted);flex:1;font-size:14px}
    .breadcrumb a{color:var(--muted);text-decoration:none}
    .breadcrumb .chev{opacity:.5}
    .btn{border:1px solid var(--line);background:var(--panel);padding:8px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.success{background:var(--success);border-color:var(--success);color:#fff}

    /* Main 3-column layout with two splitters */
    .wrap{max-width:1400px;margin:16px auto 24px;padding:0 8px}
    .grid{
      display:grid;
      grid-template-columns:minmax(360px, 1fr) 10px minmax(460px, 1.3fr) 10px minmax(340px, 0.9fr);
      gap:0 0;
      height:calc(100vh - 160px);
    }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;min-width:240px}

    /* Splitters */
    .splitter{cursor:col-resize;display:flex;align-items:center;justify-content:center}
    .splitbar{width:2px;height:70%;background:var(--line);border-radius:2px;position:relative}
    .splitbar:after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:6px;height:56px;border-radius:6px;background:var(--line)}

    /* LEFT: Blockly */
    #blocklyCard{display:flex;flex-direction:column;min-height:380px}
    #blocklySearch{border:none;border-bottom:1px solid var(--line);padding:12px 14px;font-size:14px;outline:none}
    #blocklyArea{flex:1;min-height:0}
    #blocklyDiv{height:100%;width:100%}

    /* MIDDLE: Viz */
    #vizCard{display:grid;grid-template-rows:auto 1fr;min-width:380px}
    .vizTop{display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--line);padding:10px 14px;background:linear-gradient(#fff,#fcfdff)}
    .vizTop .type{display:flex;align-items:center;gap:8px}
    .vizType{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;min-width:140px}
    .fileLabel{font-size:14px;color:var(--muted)}
    #vizCanvasWrap{padding:12px 14px}
    #vizCanvas{width:100%;height:100%}

    /* RIGHT: Data (collapsible + resizable when open) */
    #dataShell{position:relative}
    #dataCard{display:grid;grid-template-rows:auto 1fr;height:100%}
    .dataHead{border-bottom:1px solid var(--line);padding:10px 14px;background:linear-gradient(#fff,#fcfdff);font-weight:600}
    .dataBody{overflow:auto}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);padding:8px 10px;font-size:13px;text-align:left;white-space:nowrap}
    thead th{position:sticky;top:0;background:#fff}
    .dataToggle{
      position:absolute;left:-14px;top:50%;transform:translateY(-50%);
      width:28px;height:48px;border-radius:10px 0 0 10px;background:var(--tab);border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow);z-index:2
    }
    .dataToggle span{font-size:18px;color:var(--accent)}
    .collapsed #dataCard{display:none}
    .collapsed{border:1px dashed var(--line)}
    .collapsed .dataToggle{left:-14px}

    /* Code viewer */
    #codeWrap{max-width:1400px;margin:12px auto 28px;background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);display:none;overflow:hidden}
    #codeHead{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line)}
    #codeArea{padding:12px 14px;max-height:340px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12.5px;background:#fbfcff}

    @media (max-width:1200px){
      .grid{grid-template-columns:minmax(300px, 1fr) 10px minmax(440px, 1.1fr) 10px minmax(300px, 0.9fr)}
    }
  </style>

  <!-- Blockly + CSV + Chart -->
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Your blocks (unchanged; only theme colours adjusted) -->
  <script src="../src/blocks/csv_import.js"></script>
  <script src="../src/blocks/data_ops.js"></script>
  <script src="../src/blocks/statistics.js"></script>
  <script src="../src/blocks/to_json.js"></script>
</head>
<body>
  <!-- Toolbar (no site header) -->
  <div class="toolbar">
    <div class="toolbar-inner">
      <nav class="breadcrumb">
        <a href="view-project.html">My Projects</a><span class="chev">›</span>
        <a href="#">[Project Name]</a><span class="chev">›</span>
        <strong>Simulation</strong>
      </nav>
      <button id="btnShowCode" class="btn">Show code</button>
      <button id="btnPlay" class="btn primary">▶︎ Play</button>
      <a class="btn success" href="ar-demo.html">Enter AR</a>
    </div>
  </div>

  <div class="wrap">
    <div id="grid" class="grid">
      <!-- LEFT: Blockly -->
      <section id="blocklyCard" class="card">
        <input id="blocklySearch" type="search" placeholder="Search blocks…" />
        <div id="blocklyArea"><div id="blocklyDiv"></div></div>
      </section>

      <!-- Splitter 1 (between Blockly and Viz) -->
      <div id="split1" class="splitter"><div class="splitbar"></div></div>

      <!-- MIDDLE: Visualisation -->
      <section id="vizCard" class="card">
        <div class="vizTop">
          <div class="type">
            <label for="vizType" style="font-weight:600">Type</label>
            <select id="vizType" class="vizType">
              <option value="bar">Bar Chart</option>
              <option value="line" selected>Line Chart</option>
              <option value="scatter">Scatter</option>
            </select>
          </div>
          <div class="fileLabel" id="fileLabel">No file chosen</div>
        </div>
        <div id="vizCanvasWrap"><canvas id="vizCanvas"></canvas></div>
      </section>

      <!-- Splitter 2 (between Viz and Data) -->
      <div id="split2" class="splitter"><div class="splitbar"></div></div>

      <!-- RIGHT: Data Panel -->
      <aside id="dataShell" class="card">
        <div class="dataToggle" id="dataToggle" title="Collapse / expand"><span>‹</span></div>
        <section id="dataCard">
          <div class="dataHead">Data Panel</div>
          <div class="dataBody">
            <table id="dataTable"><thead></thead><tbody></tbody></table>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Code viewer -->
  <section id="codeWrap" aria-hidden="true">
    <div id="codeHead">
      <strong>Generated JavaScript</strong>
      <button id="btnCloseCode" class="btn">Close</button>
    </div>
    <pre id="codeArea"></pre>
  </section>

  <xml id="toolbox" style="display: none">
    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="120">
      <block type="controls_repeat_ext"></block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
    </category>
    <category name="Text" colour="160">
      <block type="text"></block>
      <block type="text_print"></block>
    </category>
    <category name="Lists" colour="260">
      <block type="lists_create_with"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_length"></block>
    </category>
    <category name="Variables" colour="330" custom="VARIABLE"></category>
    <category name="Functions" colour="290" custom="PROCEDURE"></category>
    <category name="Data" colour="20">
      <block type="csv_import"></block>
      <block type="to_json">
        <value name="VALUE">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="filter_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="sort_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="select_columns">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="group_by">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_column">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="drop_empty">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
    </category>
  </xml>

  <script>
    /* LIGHT THEME (only colours) */
    const LIGHT_THEME = Blockly.Theme.defineTheme('apparentlyLight', {
      base: Blockly.Themes.Classic,
      componentStyles:{
        toolboxForegroundColour:'#354355', toolboxBackgroundColour:'#eef3fa',
        flyoutBackgroundColour:'#fff', flyoutForegroundColour:'#4c5d70', flyoutOpacity:1,
        insertionMarkerOpacity:.3, scrollbarColour:'#cdd6e1'
      },
      categoryStyles:{
        logic_category:{colour:'#6aa84f'}, loops_category:{colour:'#3d85c6'}, math_category:{colour:'#674ea7'},
        text_category:{colour:'#a64d79'}, lists_category:{colour:'#bf9000'}, variables_category:{colour:'#2d8cf0'},
        functions_category:{colour:'#0b7a75'}, data_category:{colour:'#ff8a3d'}, misc_category:{colour:'#708090'}
      },
      blockStyles:{
        logic_blocks:{colourPrimary:'#6aa84f'}, loop_blocks:{colourPrimary:'#3d85c6'},
        math_blocks:{colourPrimary:'#674ea7'}, text_blocks:{colourPrimary:'#a64d79'},
        list_blocks:{colourPrimary:'#bf9000'}, variable_blocks:{colourPrimary:'#2d8cf0'},
        procedure_blocks:{colourPrimary:'#0b7a75'}
      }
    });

    /* Inject Blockly */
    const workspace = Blockly.inject('blocklyDiv', {
      theme: LIGHT_THEME,
      grid:{spacing:20,length:3,colour:'#e9eef5',snap:true},
      zoom:{controls:true,wheel:true,startScale:0.95,maxScale:2,minScale:0.5,pinch:true},
      move:{wheel:true,drag:true,scrollbars:true},
      renderer:'zelos',
      toolbox: document.getElementById('toolbox').childNodes.length ? document.getElementById('toolbox') : undefined
    });

    document.getElementById('blocklySearch').addEventListener('input', e=>{
      const q=e.target.value.trim().toLowerCase(); const tb=workspace.getToolbox(); if(!tb) return;
      if(!q){ tb.clearSearch?.(); return; } tb.search?.(q);
    });

    /* Persist workspace */
    const STORAGE_KEY='apparently.blockly.workspace';
    try{
      const saved=localStorage.getItem(STORAGE_KEY);
      if(saved) Blockly.serialization.workspaces.load(JSON.parse(saved), workspace);
      workspace.addChangeListener(()=> localStorage.setItem(STORAGE_KEY, JSON.stringify(Blockly.serialization.workspaces.save(workspace))));
    }catch{}

    /* Two splitters for resizing */
    function setupSplitter(splitId, leftIndex, rightIndex, minLeft, minRight){
      const grid=document.getElementById('grid'); const split=document.getElementById(splitId);
      let drag=false,startX=0,colsStart=[];
      split.addEventListener('mousedown', e=>{
        drag=true; startX=e.clientX;
        colsStart=getComputedStyle(grid).gridTemplateColumns.split(' ').map(v=>v.endsWith('px')?parseFloat(v):v);
        document.body.style.cursor='col-resize'; e.preventDefault();
      });
      window.addEventListener('mousemove', e=>{
        if(!drag) return;
        const dx=e.clientX-startX;
        const L=Math.max(minLeft, parseFloat(colsStart[leftIndex]) + dx);
        const R=Math.max(minRight, parseFloat(colsStart[rightIndex]) - dx);
        const cols=[...colsStart];
        cols[leftIndex]=`${L}px`; cols[rightIndex]=`${R}px`;
        grid.style.gridTemplateColumns=cols.join(' ');
        Blockly.svgResize(workspace);
      });
      window.addEventListener('mouseup', ()=>{ if(!drag) return; drag=false; document.body.style.cursor=''; Blockly.svgResize(workspace); });
    }
    // grid columns: [0]=left, [2]=middle, [4]=right
    setupSplitter('split1', 0, 2, 320, 420);
    setupSplitter('split2', 2, 4, 420, 320);

    /* Collapsible data panel */
    (function(){
      const shell=document.getElementById('dataShell'); const tab=document.getElementById('dataToggle');
      let open=true; const setIcon=()=> tab.firstElementChild.textContent=open?'‹':'›';
      tab.addEventListener('click', ()=>{
        open=!open; shell.classList.toggle('collapsed', !open);
        // when collapsed, also widen the middle column a bit
        const grid=document.getElementById('grid');
        const cols=getComputedStyle(grid).gridTemplateColumns.split(' ');
        if(!open){ cols[4]='320px'; } // keep a reasonable right min (hidden)
        grid.style.gridTemplateColumns=cols.join(' ');
        setIcon(); Blockly.svgResize(workspace);
      });
      setIcon();
    })();

    /* Chart.js rendering */
    let chart; const ctx=document.getElementById('vizCanvas').getContext('2d');
    function renderChart(rows){
      const type=document.getElementById('vizType').value || 'line';
      if(chart){ chart.destroy(); chart=null; }
      const cols = rows?.length ? Object.keys(rows[0]) : [];
      const numeric = cols.filter(c => rows.some(r => !isNaN(parseFloat(r[c]))));
      const xKey = cols[0] || 'Row'; const yKey=numeric[0] || null;
      const labels = rows.map((r,i)=> r[xKey] ?? i+1);
      const data = yKey ? rows.map(r=>parseFloat(r[yKey])) : [];
      chart = new Chart(ctx,{
        type:(type==='scatter'?'scatter':type),
        data:{
          labels:(type==='scatter'?undefined:labels),
          datasets:[{
            label:yKey||'Value',
            data:(type==='scatter')
              ? rows.map((r,i)=>({x:i+1,y:yKey?parseFloat(r[yKey]):1}))
              : (data.length?data:rows.map(()=>1)),
            tension:.25, pointRadius:3
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}}}
      });
    }

    /* Data table */
    function renderTable(rows){
      const th=document.querySelector('#dataTable thead'); const tb=document.querySelector('#dataTable tbody');
      th.innerHTML=tb.innerHTML=''; if(!rows?.length) return;
      const cols=Object.keys(rows[0]); th.innerHTML='<tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'</tr>';
      const MAX=500; const frag=document.createDocumentFragment();
      rows.slice(0,MAX).forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=cols.map(c=>`<td>${r[c]??''}</td>`).join(''); frag.appendChild(tr); });
      tb.appendChild(frag);
    }

    /* Play */
    const codeArea=document.getElementById('codeArea');
    async function runBlocks(){
      const code=Blockly.JavaScript.workspaceToCode(workspace);
      codeArea.textContent=code;
      const fname=(Blockly.CsvImportData&&Blockly.CsvImportData.filename)||'No file chosen';
      document.getElementById('fileLabel').textContent=fname;

      let resultRows=null;
      try{
        const f=new Function(`return (async()=>{ ${code}; return (typeof result!=='undefined'?result:(window.Blockly && Blockly.CsvImportData && Blockly.CsvImportData.data)||[]); })()`);
        resultRows=await f();
      }catch(e){ console.error(e); alert('Error running blocks (see console).'); resultRows=(Blockly.CsvImportData&&Blockly.CsvImportData.data)||[]; }
      if(!Array.isArray(resultRows)) resultRows=[{Value:resultRows}];

      renderChart(resultRows); renderTable(resultRows);
    }
    document.getElementById('btnPlay').addEventListener('click', runBlocks);

    document.getElementById('btnShowCode').addEventListener('click', ()=>{
      const w=document.getElementById('codeWrap'); const open=w.style.display!=='none';
      if(open){ w.style.display='none'; return; }
      codeArea.textContent=Blockly.JavaScript.workspaceToCode(workspace);
      w.style.display='block';
    });
    document.getElementById('btnCloseCode').addEventListener('click', ()=> document.getElementById('codeWrap').style.display='none');
    document.getElementById('vizType').addEventListener('change', ()=>{
      const rows=(Blockly?.CsvImportData?.data)||[]; renderChart(Array.isArray(rows)?rows:[]);
    });

    /* Keep Blockly sized */
    window.addEventListener('resize', ()=> Blockly.svgResize(workspace));
  </script>
</body>
</html>
