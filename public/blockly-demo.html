<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blockly Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Ensure Blockly.JavaScript is available before loading custom blocks
    console.log('Blockly.JavaScript available:', !!window.Blockly.JavaScript);
    console.log('Available JavaScript generators before CSV import:', Object.keys(window.Blockly.JavaScript || {}));
  </script>
  <script src="../src/blocks/csv_import.js"></script>
  <script src="../src/blocks/to_json.js"></script>
  <script>
    // Check if CSV import generator was registered
    console.log('CSV import generator registered after loading:', !!window.Blockly.JavaScript['csv_import']);
    console.log('CSV import generator type:', typeof window.Blockly.JavaScript['csv_import']);
    
    // Show all available generators that might be block-related
    const allKeys = Object.keys(window.Blockly.JavaScript || {});
    const blockKeys = allKeys.filter(key => !key.startsWith('ORDER_') && !key.startsWith('STATEMENT_') && !key.startsWith('FUNCTION_') && !key.startsWith('INFINITE_') && !key.startsWith('INDENT') && !key.startsWith('COMMENT_') && !key.startsWith('RESERVED_') && key.length > 2);
    console.log('Block-related generators:', blockKeys);
    
    // Test the generator directly
    setTimeout(() => {
      if (window.Blockly.JavaScript['csv_import']) {
        try {
          console.log('Testing CSV generator directly...');
          const result = window.Blockly.JavaScript['csv_import']();
          console.log('Direct generator test result:', result);
        } catch (e) {
          console.error('Direct generator test failed:', e);
        }
      }
    }, 200);
  </script>
  <style>
    /* Custom Tailwind configuration for Blockly and specific component styling */
    html, body {
      @apply h-full m-0 p-0 bg-slate-50 font-sans;
    }
    body {
      @apply h-screen w-screen flex flex-col;
    }
    
    /* Preserve some specific styles that need exact values */
    #blocklyDiv {
      flex: 1 1 60%;
    }
    
    /* React component styles using Tailwind classes */
    .data-visualization-panel, .chart-controls {
      @apply bg-white border border-slate-200 rounded-lg p-4 mb-4;
    }
    
    .data-visualization-panel h3, .chart-controls h4 {
      @apply m-0 mb-3 text-slate-700;
    }
    
    .panel-header {
      @apply flex justify-between items-center mb-4;
    }
    
    .load-sample-btn, .generate-btn {
      @apply bg-blue-500 text-white border-none rounded-md px-4 py-2 cursor-pointer text-sm transition-colors hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed;
    }
    
    .control-group {
      @apply mb-3;
    }
    
    .control-group label {
      @apply block mb-1 font-medium text-slate-700;
    }
    
    .control-group select {
      @apply w-full p-2 border border-slate-200 rounded text-sm;
    }
    
    .error-message {
      @apply bg-red-50 text-red-700 px-3 py-2 rounded mb-4 border-l-4 border-red-700;
    }
    
    .chart-container {
      @apply mt-4;
    }
    
    .chart-info {
      @apply flex gap-5 my-2 text-sm text-gray-600;
    }
    
    .chart-config {
      @apply bg-gray-50 border border-slate-200 rounded p-3 text-xs max-h-72 overflow-y-auto;
    }
    
    /* Responsive overrides */
    @media (max-width: 700px) {
      .main-content-mobile { @apply p-1; }
      #blocklyDiv { @apply min-h-56; }
      .header-mobile { @apply text-xl px-2 py-2; }
    }
  </style>
</head>
<body>
  <div class="px-8 py-4 text-2xl font-bold text-slate-700 bg-slate-50 tracking-wide max-md:text-xl max-md:px-2 max-md:py-2">Blockly Demo</div>
  <div class="flex-1 flex flex-col px-8 pb-8 min-h-0 max-md:p-1">
    <div id="blocklyDiv" class="flex-1 min-h-96 w-full rounded-xl border border-slate-200 mb-4 bg-white overflow-hidden max-md:min-h-56"></div>
    <xml id="toolbox" style="display: none">
      <category name="Logic" colour="210">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
      </category>
      <category name="Loops" colour="120">
        <block type="controls_repeat_ext"></block>
        <block type="controls_whileUntil"></block>
      </category>
      <category name="Math" colour="230">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_single"></block>
        <block type="math_round"></block>
        <block type="math_on_list"></block>
      </category>
      <category name="Text" colour="160">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Lists" colour="260">
        <block type="lists_create_with"></block>
        <block type="lists_getIndex"></block>
        <block type="lists_setIndex"></block>
        <block type="lists_length"></block>
      </category>
      <category name="Variables" colour="330" custom="VARIABLE"></category>
      <category name="Functions" colour="290" custom="PROCEDURE"></category>
      <category name="Data" colour="20">
        <block type="csv_import"></block>
        <block type="to_json">
          <value name="VALUE">
            <block type="csv_import"></block>
          </value>
        </block>
      </category>
    </xml>
    <div class="mb-3">
      <button id="runButton" class="bg-blue-500 text-white border-none rounded-md px-4 py-2 mr-2 text-base cursor-pointer transition-colors hover:bg-blue-600">Run Code</button>
      <button id="showCodeButton" class="bg-blue-500 text-white border-none rounded-md px-4 py-2 mr-2 text-base cursor-pointer transition-colors hover:bg-blue-600">Show Code</button>
    </div>
    <pre id="output" class="bg-slate-900 text-slate-200 p-3 min-h-10 rounded-md font-mono text-base mb-4 shadow-sm w-full mt-0"></pre>
    
    <!-- React component containers -->
    <div id="react-controls-container"></div>
    <div id="react-chart-container"></div>
  </div>
  <script>
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox')
    });

    const output = document.getElementById('output');

    document.getElementById('runButton').onclick = function() {
      output.textContent = '';
      console.log('Run button clicked');
      try {
        console.log('Workspace blocks:', workspace.getAllBlocks().map(b => b.type));
        console.log('CSV import generator available:', !!Blockly.JavaScript['csv_import']);
        console.log('Calling workspaceToCode...');
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        console.log('Generated code:', code);
        if (!code.trim()) {
          output.textContent = 'No code generated - make sure you have blocks in the workspace';
          return;
        }
        // eslint-disable-next-line no-eval
        const result = eval(code);
        console.log('Execution result:', result);
        if (result !== undefined) output.textContent = result;
      } catch (e) {
        console.error('Error details:', e);
        output.textContent = 'Error: ' + e;
      }
    };

    document.getElementById('showCodeButton').onclick = function() {
      console.log('Show code button clicked');
      console.log('Workspace blocks:', workspace.getAllBlocks().map(b => b.type));
      console.log('CSV import generator available:', !!Blockly.JavaScript['csv_import']);
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      console.log('Generated code:', code);
      output.textContent = code || 'No code generated';
    };

    // External CSV upload handler - only add if element exists
    const csvUploadExternal = document.getElementById('csv-upload-external');
    if (csvUploadExternal) {
      csvUploadExternal.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            Papa.parse(event.target.result, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                Blockly.CsvImportData.data = results.data;
                Blockly.CsvImportData.filename = file.name;
                alert('CSV imported: ' + file.name + '\nRows: ' + results.data.length);
              }
            });
          };
          reader.readAsText(file);
        }
      });
    }
  </script>
  
  <!-- Include React bundle -->
  <script src="react-bundle.js"></script>
</body>
</html> 