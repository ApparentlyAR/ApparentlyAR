<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="icon" href="favicon.ico" />
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>ApparentlyAR - Simulation</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: '#F8F9FA',
            panel: '#FFFFFF',
            border: '#E5E7EB',
            text: '#1F2937',
            muted: '#6B7280',
            primary: '#22C55E',
            'primary-hover': '#16A34A',
            secondary: '#4F46E5',
          },
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif'],
          }
        },
      },
    };
  </script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script>
    // Ensure Blockly.JavaScript is available before loading custom blocks
    console.log('Blockly.JavaScript available:', !!window.Blockly.JavaScript);
    console.log('Available JavaScript generators before CSV import:', Object.keys(window.Blockly.JavaScript || {}));
  </script>
  <script src="../src/react/api.js"></script>
  <script src="../src/blocks/csv_import.js"></script>
  <script src="../src/blocks/to_json.js"></script>
  <script src="../src/blocks/data_ops.js"></script>
  <script src="../src/blocks/statistics.js"></script>
  <script src="../src/blocks/visualization.js"></script>
  <script>
    // Check if CSV import & data-op generators were registered
    console.log('CSV import generator registered after loading:', !!window.Blockly.JavaScript['csv_import']);
    console.log('filter_data generator registered after loading:', !!(window.Blockly.JavaScript && window.Blockly.JavaScript['filter_data']));
    console.log('AppApi available:', !!window.AppApi);
    console.log('AppApi.processData available:', !!window.AppApi?.processData);

    // Show all available generators that might be block-related
    const allKeys = Object.keys(window.Blockly.JavaScript || {});
    const blockKeys = allKeys.filter(key => !key.startsWith('ORDER_') && !key.startsWith('STATEMENT_') && !key.startsWith('FUNCTION_') && !key.startsWith('INFINITE_') && !key.startsWith('INDENT') && !key.startsWith('COMMENT_') && !key.startsWith('RESERVED_') && key.length > 2);
    console.log('Block-related generators:', blockKeys);

    // Test the generators directly
    setTimeout(() => {
      if (window.Blockly.JavaScript['csv_import']) {
        try {
          console.log('Testing CSV generator directly...');
          const result = window.Blockly.JavaScript['csv_import']();
          console.log('Direct CSV generator test result:', result);
        } catch (e) {
          console.error('Direct CSV generator test failed:', e);
        }
      }
    }, 200);
  </script>
  <style>
    /* Custom styles for the new layout */
    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: #F8F9FA;
      user-select: none; /* Prevent text selection during drag */
    }

    /* Allow text selection in code output */
    #output-root {
      user-select: text;
      cursor: text;
    }

    /* Copy button styles */
    .copy-button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #4F46E5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .copy-button:hover {
      background: #3730A3;
    }
    
    .copy-button.copied {
      background: #10B981;
    }

    /* Panels and resizers */
    #main-content-grid {
        display: grid;
        grid-template-columns: 320px 8px 1fr 8px 360px; 
    }
    
    .grid-transition {
        transition: grid-template-columns 0.3s ease-in-out;
    }

    /* Resizer handle styles */
    .resizer {
      background: #F8F9FA;
      cursor: col-resize;
      z-index: 10;
      position: relative;
    }
    .resizer:hover::after, .resizer.is-dragging::after {
      content: '';
      position: absolute;
      top: 0;
      left: 3px;
      width: 2px;
      height: 100%;
      background: #4F46E5; /* secondary color */
    }
    
    /* Allow panels to shrink to zero */
    #blocks-panel, #data-panel {
        min-width: 0;
    }
    
    /* Enable horizontal scrolling for Blockly panel */
    #blocks-panel {
        overflow-x: auto;
        overflow-y: hidden;
    }
    
    #blocklyDiv {
        min-width: 100%;
        overflow-x: auto;
    }

    #toggle-data-panel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 20;
        transition: right 0.3s ease-in-out;
    }

    #main-content-grid.data-closed #data-panel {
        overflow: hidden;
    }

    /* Code panel toggle transition */
    #code-panel {
      transition: height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      height: 200px;
      opacity: 1;
      overflow: hidden;
    }
    #code-panel.hidden {
      height: 0;
      opacity: 0;
      padding: 0;
    }
    #code-panel pre {
        background-color: #F3F4F6;
        border: 1px solid #E5E7EB;
        color: #111827;
    }

    /* Tweak Blockly's appearance */
    .blocklyToolboxDiv {
        background-color: #F3F4F6;
        border-right: 1px solid #E5E7EB;
        overflow-y: hidden !important; /* Remove toolbox category scrollbar */
    }
    
    .blocklyFlyout {
      overflow: hidden !important;
    }
    
    .blocklyFlyoutScrollbar {
      display: none !important;
    }

    /* Ensure proper sizing for Blockly workspace */
    .blocklySvg {
      display: block;
    }

    /* Fix for scrollbars appearing when not needed */
    .blocklyToolboxDiv::-webkit-scrollbar {
      display: none;
    }
    
    .blocklyToolboxDiv {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .blocklyTreeRow.blocklyTreeSelected {
        background-color: #E0E7FF !important;
    }
     .blocklyTreeRow:not(.blocklyTreeSelected):hover {
        background-color: #EFF6FF !important;
    }
    
    /* Fix for data panel header */
    #data-panel-content th {
        position: sticky;
        top: 0;
        z-index: 1; /* Ensures header is above scrolling content */
        background-color: #F9FAFB; /* Added background to fix the "hole" */
    }
  </style>
</head>

<body class="text-text bg-background">

  <div id="header-container"></div>

  <div class="flex flex-col h-screen">
    <!-- Top Bar -->
    <header class="bg-[#f8fafc] border-b border-border shadow-sm flex-shrink-0">
      <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <nav class="hidden md:flex items-center space-x-2 text-sm">
              <a id="breadcrumb-dashboard-link" href="#" class="text-muted hover:text-text">My Project</a>
              <span class="text-gray-300">></span>
              <a id="breadcrumb-project-link" href="#" class="text-muted hover:text-text">Visualisation 1</a>
              <span class="text-gray-300">></span>
              <span class="text-text font-medium">Simulation</span>
            </nav>
          </div>
          <div class="flex items-center gap-3">
             <button onclick="executeBlocklyCode()"
              class="bg-primary hover:bg-primary-hover text-white font-bold py-2 px-3 rounded-lg flex items-center justify-center transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
            </button>
            <button onclick="window.location.href='ar-demo.html'"
              class="bg-panel border border-border text-white text-text hover:bg-yellow-500 bg-yellow-400 font-medium py-2 px-4 rounded-lg transition-colors">
              Enter AR
            </button>
             <button id="show-code-btn" onclick="toggleCodePanel()"
              class="bg-panel border border-border text-white text-text hover:bg-red-300 bg-red-400 font-medium py-2 px-4 rounded-lg transition-colors">
              Show code
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 relative overflow-hidden">
      <main id="main-content-grid" class="h-full">
        <!-- Blocks Panel -->
        <aside id="blocks-panel" class="flex flex-col bg-panel overflow-x-auto overflow-y-hidden">
          <div class="p-2 border-b border-border">
            <input class="w-full px-3 py-2 rounded-lg border border-border bg-background text-sm text-text placeholder-muted focus:outline-none focus:ring-2 focus:ring-secondary"
              placeholder="Search blocks..." />
          </div>
          <div id="blocklyDiv" class="w-full h-full flex-1 overflow-x-auto"></div>
        </aside>
  
        <!-- Left Resizer -->
        <div class="resizer" id="resizer-left"></div>

        <!-- Middle Panel: Visualization -->
        <section id="viz-panel" class="flex flex-col bg-background overflow-hidden">
          <div class="flex items-center justify-between gap-2 p-2.5 border-b border-border bg-panel flex-shrink-0">
              <span id="csv-filename" class="text-sm font-medium text-text">No file loaded</span>
              <div class="flex items-center gap-2">
                  <span class="text-sm text-muted">Use visualization blocks to generate charts</span>
              </div>
          </div>
          <div class="flex-1 p-4 min-h-0">
               <div id="react-chart-container" class="w-full h-full bg-panel rounded-lg border border-border flex items-center justify-center text-muted p-4 relative">
                  Visualization will appear here when blocks are executed
              </div>
          </div>
        </section>

        <!-- Right Resizer -->
        <div class="resizer" id="resizer-right"></div>
  
        <!-- Right Panel: Data -->
        <aside id="data-panel" class="bg-panel flex flex-col overflow-hidden">
            <div class="flex items-center justify-between p-2.5 border-b border-border">
              <strong class="text-sm font-medium">Data Panel</strong>
            </div>
          <div id="data-panel-content" class="overflow-auto flex-1 p-2">
              <div class="text-sm text-muted text-center py-8">
              Data will appear here when imported.
              </div>
          </div>
        </aside>
      </main>

      <!-- Toggle button -->
      <button id="toggle-data-panel-btn" onclick="toggleDataPanel()" class="bg-panel hover:bg-gray-100 text-muted hover:text-text rounded-full shadow-md w-6 h-10 flex items-center justify-center border border-border">
        <svg id="toggle-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </button>

    </div>

     <!-- Bottom Panel: Code Output -->
    <footer id="code-panel" class="bg-panel border-t border-border p-2 hidden flex-shrink-0">
      <div class="relative h-full">
        <button id="copy-code-btn" class="copy-button" onclick="copyGeneratedCode()" title="Copy code to clipboard">
          Copy
        </button>
        <pre id="output-root" class="h-full w-full rounded-md p-2 pr-20 text-sm font-mono overflow-auto"></pre>
      </div>
    </footer>

  </div>

  <!-- Blockly Toolbox Definition -->
  <xml id="toolbox" style="display: none">
    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="120">
      <block type="controls_repeat_ext"></block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
    </category>
    <category name="Text" colour="160">
      <block type="text"></block>
      <block type="text_print"></block>
    </category>
    <category name="Lists" colour="260">
      <block type="lists_create_with"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_length"></block>
    </category>
    <category name="Variables" colour="330" custom="VARIABLE"></category>
    <category name="Functions" colour="290" custom="PROCEDURE"></category>
    <category name="Data" colour="20">
      <block type="csv_import"></block>
      <block type="to_json">
        <value name="VALUE">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="filter_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="sort_data">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="select_columns">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="group_by">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_column">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="drop_empty">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
    </category>
    <category name="Statistical Analysis" colour="40">
      <block type="descriptive_stats">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_mean">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_median">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_std">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_correlation">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="detect_outliers">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="frequency_count">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="calculate_percentiles">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
    </category>
    <category name="Visualization" colour="330">
      <block type="set_chart_type"></block>
      <block type="set_axes">
        <value name="CONFIG">
          <block type="set_chart_type"></block>
        </value>
      </block>
      <block type="chart_options">
        <value name="CONFIG">
          <block type="set_chart_type"></block>
        </value>
      </block>
      <block type="advanced_chart_options">
        <value name="CONFIG">
          <block type="set_chart_type"></block>
        </value>
      </block>
      <block type="generate_visualization">
        <value name="CONFIG">
          <block type="set_chart_type"></block>
        </value>
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="quick_chart">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="histogram_config">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="boxplot_config">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
      <block type="heatmap_config">
        <value name="DATA">
          <block type="csv_import"></block>
        </value>
      </block>
    </category>
  </xml>

  <!-- BLOCK DEFINITIONS AND GENERATORS SCRIPT (minified for brevity) -->
  <script>
    // --- Universal Dropdown Logic ---
    function closeAllDropdowns() {
      document.querySelectorAll('.project-dropdown').forEach(menu => menu.classList.add('hidden'));
    }
    function toggleUserMenu(event) {
      event.stopPropagation();
      const menu = document.getElementById('user-menu');
      const isHidden = menu.classList.contains('hidden');
      closeAllDropdowns();
      if (isHidden) menu.classList.remove('hidden');
    }
    function logout(event) {
      event.preventDefault();
      console.log("User logged out.");
      window.location.href = '/';
    }
    window.addEventListener('click', function (event) {
      if (!event.target.closest('.dropdown-toggle')) {
        closeAllDropdowns();
      }
    });

    // --- Page Header Logic ---
    document.addEventListener('DOMContentLoaded', () => {
      fetch('header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header-container').innerHTML = data;
        // Once header is loaded, run the main page logic
        initializeApp();
      });
    });
    
    // Block definitions are loaded from external files to avoid conflicts
  

  <!-- MAIN APPLICATION SCRIPT -->
    let workspace;
    let chartInstance;
    
    // Blockly theme
    const lightTheme = Blockly.Theme.defineTheme('lightTheme', {
      'base': Blockly.Themes.Classic,
      'componentStyles': {
        'workspaceBackgroundColour': '#FFFFFF', 'toolboxBackgroundColour': '#F3F4F6',
        'toolboxForegroundColour': '#1F2937', 'flyoutBackgroundColour': '#FFFFFF',
        'flyoutForegroundColour': '#1F2937', 'scrollbarColour': '#D1D5DB',
      },
    });

    // Initialize Blockly Workspace
    workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: { spacing: 25, length: 2, colour: '#F1F5F9', snap: true },
      zoom: { controls: true, wheel: true, startScale: 0.8, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
      move: { scrollbars: false, drag: true, wheel: true },
      trashcan: true,
      theme: lightTheme,
      renderer: 'geras'
    });
    
    // --- UI Interaction Functions ---
    const mainGrid = document.getElementById('main-content-grid');
    const toggleBtn = document.getElementById('toggle-data-panel-btn');

    function updateToggleButtonPosition() {
        const dataPanel = document.getElementById('data-panel');
        const resizerRight = document.getElementById('resizer-right');
        const isClosed = mainGrid.classList.contains('data-closed');
        if (isClosed) {
            toggleBtn.style.right = '0px';
        } else {
            toggleBtn.style.right = `${dataPanel.offsetWidth + resizerRight.offsetWidth}px`;
        }
    }
    
    function toggleDataPanel() {
        const isClosing = !mainGrid.classList.contains('data-closed');
        if (isClosing) {
            // Store the current width before closing
            dataPanelWidth = document.getElementById('data-panel').offsetWidth;
        }

        mainGrid.classList.add('grid-transition');
        mainGrid.classList.toggle('data-closed');
        
        const blocksPanelWidth = document.getElementById('blocks-panel').offsetWidth;
        const currentDataWidth = isClosing ? 0 : dataPanelWidth;
        mainGrid.style.gridTemplateColumns = `${blocksPanelWidth}px 8px 1fr 8px ${currentDataWidth}px`;

        document.getElementById('toggle-icon').innerHTML = isClosing 
            ? '<polyline points="15 18 9 12 15 6"></polyline>' // Left arrow
            : '<polyline points="9 18 15 12 9 6"></polyline>';  // Right arrow
        
        mainGrid.addEventListener('transitionend', () => {
            window.dispatchEvent(new Event('resize')); 
            mainGrid.classList.remove('grid-transition');
        }, { once: true });
    }

    function toggleCodePanel() {
        document.getElementById('code-panel').classList.toggle('hidden');
    }
    
    // --- Blockly Code Execution ---
    async function executeBlocklyCode() {
      try {
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        updateCodeOutput(code);
        if (!code.trim()) return;

        const asyncWrapper = `(async () => { return ${code} })();`;
        let result = await eval(asyncWrapper);
        
        // Handle different types of results
        if (result === undefined && Blockly.CsvImportData) {
            result = Blockly.CsvImportData.data;
        }
        
        // Check if result is a chart configuration or handled by visualization blocks
        console.log('🔍 Checking result type:', typeof result, 'has chartType:', !!(result && result.chartType), 'has handled:', !!(result && result.handled));
        if (result && typeof result === 'object' && (result.chartType || result.handled === 'chartGenerated')) {
          console.log('🎨 Detected chart from visualization blocks or handled by event system:', result);
          // Chart is handled by the chartGenerated event system, don't render fallback
          if (!result.handled) {
            await handleAdvancedVisualization(result);
          }
        } else {
          console.log('📊 Taking standard data rendering path');
          // Standard data rendering for basic blocks
          renderDataPanel(result);
          renderDataVisualization(result);
        }
        
        // Dispatch event for backward compatibility with React components
        window.dispatchEvent(new CustomEvent('blocklyExecuted', { detail: { result } }));
        
      } catch (e) {
        console.error('Error executing Blockly code:', e);
        updateCodeOutput(`Error: ${e.message}`);
      }
    }
    
    // Handle advanced visualization blocks that output chart configurations
    async function handleAdvancedVisualization(chartConfig) {
      try {
        console.log('🔧 Processing advanced visualization with config:', chartConfig);
        
        // If we have backend API available, use it for advanced charts
        if (window.AppApi && window.AppApi.generateChart) {
          const chartResult = await window.AppApi.generateChart(
            chartConfig.data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : []),
            chartConfig.chartType,
            chartConfig.options || {}
          );
          
          if (chartResult && chartResult.success) {
            renderAdvancedChart(chartResult);
            return;
          }
        }
        
        // Fallback to client-side rendering for supported chart types
        const data = chartConfig.data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : []);
        renderDataPanel(data);
        renderDataVisualization(data, chartConfig);
        
      } catch (error) {
        console.error('Error handling advanced visualization:', error);
        updateCodeOutput(`Visualization Error: ${error.message}`);
      }
    }
    
    
    function updateCodeOutput(content) {
        document.getElementById('output-root').textContent = content || "Workspace is empty.";
    }
    
    // Copy generated code to clipboard
    function copyGeneratedCode() {
        const codeContent = document.getElementById('output-root').textContent;
        if (!codeContent || codeContent === "Workspace is empty.") {
            alert('No code to copy. Generate some code first!');
            return;
        }
        
        navigator.clipboard.writeText(codeContent).then(() => {
            const copyBtn = document.getElementById('copy-code-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('copied');
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
                copyBtn.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy code:', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeContent;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert('Code copied to clipboard!');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Unable to copy code automatically. Please select and copy manually.');
            }
            document.body.removeChild(textArea);
        });
    }
    
    // Render advanced charts from backend API or visualization blocks
    function renderAdvancedChart(chartResult) {
      console.log('🎨 renderAdvancedChart called with:', chartResult);
      const container = document.getElementById('react-chart-container');
      
      // Destroy existing chart
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }
      
      if (!chartResult || !chartResult.config) {
        console.error('Invalid chart result:', chartResult);
        container.innerHTML = '<div class="text-center text-muted p-8">Failed to generate chart - invalid configuration</div>';
        return;
      }
      
      try {
        container.innerHTML = '<canvas id="chart-canvas" class="w-full h-full"></canvas>';
        const canvas = document.getElementById('chart-canvas');
        const ctx = canvas.getContext('2d');
        
        console.log('📊 Creating chart with full result:', chartResult);
        console.log('📊 Chart config type:', chartResult.config.type);
        console.log('📊 Chart config data:', chartResult.config.data);
        console.log('📊 Chart config options:', chartResult.config.options);
        
        chartInstance = new Chart(ctx, chartResult.config);
        console.log('📊 Chart instance created, type:', chartInstance.config.type);
        
        // Update data panel with the chart data if available
        if (chartResult.data) {
          renderDataPanel(chartResult.data);
        }
        
      } catch (error) {
        console.error('Error creating chart:', error);
        container.innerHTML = '<div class="text-center text-muted p-8">Error creating chart: ' + error.message + '</div>';
      }
    }

    // --- Data & Visualization Rendering ---
    function renderDataPanel(data) {
        const container = document.getElementById('data-panel-content');
        const dataToRender = data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : null);
        if (!dataToRender || dataToRender.length === 0) {
            container.innerHTML = `<div class="text-sm text-muted text-center p-4">No data to display.</div>`;
            return;
        }
        const headers = Object.keys(dataToRender[0]);
        let tableHtml = `<table class="min-w-full text-sm"><thead><tr>`;
        headers.forEach(h => { tableHtml += `<th class="px-2 py-2 text-left font-medium text-muted">${h}</th>`; });
        tableHtml += `</tr></thead><tbody class="divide-y divide-border">`;
        dataToRender.slice(0, 100).forEach(row => {
            tableHtml += `<tr>`;
            headers.forEach(h => { tableHtml += `<td class="px-2 py-1 whitespace-nowrap overflow-hidden text-ellipsis">${row[h] || ''}</td>`; });
            tableHtml += `</tr>`;
        });
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }

    function renderDataVisualization(data, chartConfig = null) {
        console.log('🖼️ renderDataVisualization called with:', { data: !!data, chartConfig });
        const container = document.getElementById('react-chart-container');
        const dataToRender = data || (Blockly.CsvImportData ? Blockly.CsvImportData.data : null);
        if (chartInstance) {
            console.log('🖼️ Destroying existing chart instance');
            chartInstance.destroy();
        }
        if (!dataToRender || dataToRender.length === 0) {
            container.innerHTML = 'Run blocks with data to generate a visualization.';
            return;
        }
        
        container.innerHTML = '<canvas id="chart-canvas"></canvas>';
        const ctx = document.getElementById('chart-canvas').getContext('2d');
        
        // Use chart configuration from advanced blocks if provided
        if (chartConfig && chartConfig.chartType) {
            console.log('📊 Using advanced chart configuration:', chartConfig);
            
            const { labels, datasets } = prepareChartData(dataToRender, chartConfig);
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                ...chartConfig.options
            };
            
            chartInstance = new Chart(ctx, {
                type: chartConfig.chartType,
                data: { labels, datasets },
                options: options
            });
        } else {
            // Fallback: basic bar chart when no advanced configuration is provided
            const { labels, datasets } = prepareChartData(dataToRender);
            chartInstance = new Chart(ctx, {
                type: 'bar', // Default to bar chart
                data: { labels, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
    }

    function prepareChartData(data, chartConfig = null) {
        if (!data || data.length === 0) return { labels: [], datasets: [] };
        const headers = Object.keys(data[0]);
        
        // Use configuration from advanced blocks if provided
        if (chartConfig && (chartConfig.xColumn || chartConfig.yColumn)) {
            const labelColumn = chartConfig.xColumn || headers[0];
            const dataColumns = chartConfig.yColumn ? [chartConfig.yColumn] : 
                                headers.filter(h => h !== labelColumn && !isNaN(parseFloat(data[0][h])));
            
            const labels = data.map(row => row[labelColumn]);
            const datasets = dataColumns.map((col, index) => {
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EC4899', '#8B5CF6'];
                return {
                    label: col,
                    data: data.map(row => parseFloat(row[col]) || 0),
                    backgroundColor: colors[index % colors.length] + '80',
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            return { labels, datasets };
        }
        
        // Standard auto-detection for basic blocks
        let labelColumn = headers.find(h => isNaN(parseFloat(data[0][h]))) || headers[0];
        let dataColumns = headers.filter(h => h !== labelColumn && !isNaN(parseFloat(data[0][h])));
        if(dataColumns.length === 0 && headers.length > 1) dataColumns.push(headers[1]);

        const labels = data.map(row => row[labelColumn]);
        const datasets = dataColumns.map((col, index) => {
             const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EC4899', '#8B5CF6'];
            return {
                label: col,
                data: data.map(row => parseFloat(row[col]) || 0),
                backgroundColor: colors[index % colors.length] + '80',
                borderColor: colors[index % colors.length],
                borderWidth: 1
            }
        });
        return { labels, datasets };
    }
    
    // --- Panel Resizing Logic ---
    let blocksPanelWidth = 320;
    let dataPanelWidth = 360;

    function initializeResizing() {
        const resizerLeft = document.getElementById('resizer-left');
        const resizerRight = document.getElementById('resizer-right');

        function makeResizable(resizer) {
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                let isDragging = true;
                resizer.classList.add('is-dragging');
                document.body.style.cursor = 'col-resize';
                
                const onMouseMove = (moveEvent) => {
                    if (!isDragging) return;
                    
                    const rect = mainGrid.getBoundingClientRect();
                    const isDataPanelClosed = mainGrid.classList.contains('data-closed');

                    if (resizer === resizerLeft) {
                        blocksPanelWidth = Math.max(250, moveEvent.clientX - rect.left);
                    } else if (!isDataPanelClosed) {
                        dataPanelWidth = Math.max(250, rect.right - moveEvent.clientX);
                    }
                    
                    const currentDataWidth = isDataPanelClosed ? 0 : dataPanelWidth;
                    mainGrid.style.gridTemplateColumns = `${blocksPanelWidth}px 8px 1fr 8px ${currentDataWidth}px`;
                    
                    window.dispatchEvent(new Event('resize'));
                };

                const onMouseUp = () => {
                    isDragging = false;
                    resizer.classList.remove('is-dragging');
                    document.body.style.cursor = '';
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                };
                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }
        makeResizable(resizerLeft);
        makeResizable(resizerRight);
    }

    // --- App Initialization ---
    function initializeApp() {
        // Set up breadcrumb navigation
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        const role = urlParams.get('role');
        
        // Set dashboard link based on role
        const breadcrumbDashboardLink = document.getElementById('breadcrumb-dashboard-link');
        const breadcrumbProjectLink = document.getElementById('breadcrumb-project-link');
        const headerLink = document.getElementById('header-dashboard-link');
        
        if (breadcrumbDashboardLink) {
            const dashboardUrl = role === 'student' ? 'student-dashboard.html' : 'teacher-dashboard.html';
            breadcrumbDashboardLink.href = dashboardUrl;
        }
        
        if (breadcrumbProjectLink && projectId) {
            // Navigate to the view-project page for this specific project
            breadcrumbProjectLink.href = `view-project.html?id=${projectId}${role ? '&role=' + role : ''}`;
        }
        
        if (headerLink) {
            const headerDashboardUrl = role === 'student' ? 'student-dashboard.html' : 'teacher-dashboard.html';
            headerLink.href = headerDashboardUrl;
        }

        // Chart generation is now handled solely by Blockly visualization blocks

        window.addEventListener('csvDataChanged', (e) => {
            document.getElementById('csv-filename').textContent = e.detail.filename || 'No file loaded';
            renderDataPanel();
            if (window.BlocklyAutofill) window.BlocklyAutofill.updateAllBlocksWithAutofill();
        });
        
        // Listen for chart generation from visualization blocks
        window.addEventListener('chartGenerated', (e) => {
            console.log('📊 Chart generated event received:', e.detail);
            if (e.detail && e.detail.config) {
                renderAdvancedChart(e.detail);
            }
        });

        workspace.addChangeListener((event) => {
          // Fix for toolbox not closing
          if (event.type === Blockly.Events.BLOCK_DRAG && !event.isStart || event.type === Blockly.Events.SELECTED) {
             if (workspace.getToolbox() && workspace.getToolbox().getFlyout()) {
               workspace.getToolbox().getFlyout().hide();
             }
          }
        });

        window.addEventListener('resize', () => {
          if(workspace) Blockly.svgResize(workspace);
          if(chartInstance) chartInstance.resize();
          updateToggleButtonPosition();
        });

        initializeResizing();
        updateToggleButtonPosition();
    }
    
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>