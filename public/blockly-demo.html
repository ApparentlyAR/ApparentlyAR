<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <title>ApparentlyAR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: "#0f1320",
            panel: "#171c2b",
            panel2: "#1e2436",
            text: "#e7ebff",
            muted: "#a9b4d0",
            accent: "#6ea8fe",
            accent2: "#7ee6c8",
            warn: "#ffce73",
            error: "#ff8a8a",
            ok: "#8ff0a4",
            chip: "#2a3350",
            border: "#2b3350",
          },
          boxShadow: {
            inset: "inset 0 2px 0 #0a0d18",
          },
        },
      },
    };
  </script>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <script>
    // Ensure Blockly.JavaScript is available before loading custom blocks
    console.log('Blockly.JavaScript available:', !!window.Blockly.JavaScript);
    console.log('Available JavaScript generators before CSV import:', Object.keys(window.Blockly.JavaScript || {}));
  </script>
  <script src="../src/blocks/csv_import.js"></script>
  <script src="../src/blocks/to_json.js"></script>
  <script>
    // Check if CSV import generator was registered
    console.log('CSV import generator registered after loading:', !!window.Blockly.JavaScript['csv_import']);
    console.log('CSV import generator type:', typeof window.Blockly.JavaScript['csv_import']);
    
    // Show all available generators that might be block-related
    const allKeys = Object.keys(window.Blockly.JavaScript || {});
    const blockKeys = allKeys.filter(key => !key.startsWith('ORDER_') && !key.startsWith('STATEMENT_') && !key.startsWith('FUNCTION_') && !key.startsWith('INFINITE_') && !key.startsWith('INDENT') && !key.startsWith('COMMENT_') && !key.startsWith('RESERVED_') && key.length > 2);
    console.log('Block-related generators:', blockKeys);
    
    // Test the generator directly
    setTimeout(() => {
      if (window.Blockly.JavaScript['csv_import']) {
        try {
          console.log('Testing CSV generator directly...');
          const result = window.Blockly.JavaScript['csv_import']();
          console.log('Direct generator test result:', result);
        } catch (e) {
          console.error('Direct generator test failed:', e);
        }
      }
    }, 200);
  </script>
  <style>
    /* Grid template areas utility */
    [data-areas="desktop"] {
      grid-template-areas:
        "topbar topbar topbar"
        "blocks stage data"
        "guide guide guide";
    }
    @media (max-width: 980px) {
      [data-areas="desktop"] {
        grid-template-areas:
          "topbar"
          "stage"
          "blocks"
          "data"
          "guide";
        grid-template-columns: 1fr !important;
        grid-template-rows: 56px 1fr auto auto 140px !important;
        height: auto !important;
        min-height: 100vh;
      }
    }
    .camera-checker {
      background-image: linear-gradient(45deg, #1b2441 25%, transparent 25%),
        linear-gradient(-45deg, #1b2441 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #1b2441 75%),
        linear-gradient(-45deg, transparent 75%, #1b2441 75%);
      background-size: 24px 24px;
      background-position: 0 0, 0 12px, 12px -12px, -12px 0px;
    }

    /* Blockly styling adjustments for dark theme */
    .blocklyToolboxDiv {
      background-color: #171c2b !important;
      border-right: 1px solid #2b3350 !important;
    }
    
    .blocklyFlyoutBackground {
      fill: #171c2b !important;
    }
    
    .blocklyMainBackground {
      fill: #0f1324 !important;
    }
    
    .blocklyScrollbarBackground {
      fill: #1e2436 !important;
    }
    
    .blocklyScrollbarHandle {
      fill: #a9b4d0 !important;
    }
    
    .blocklyText {
      fill: #e7ebff !important;
    }

    /* Chart.js mobile responsiveness */
    .chart-container {
      position: relative;
      width: 100%;
    }
    
    @media (max-width: 640px) {
      .chart-container {
        height: 300px !important;
      }
      
      .chart-container canvas {
        max-width: 100% !important;
        height: auto !important;
      }
    }
  </style>
</head>
<body class="m-0 text-text bg-[radial-gradient(1200px_700px_at_70%_-10%,#1b2240,#0a0d18)] min-h-screen">
  <div
    class="grid h-screen overflow-hidden"
    style="
      grid-template-rows: 56px 1fr 120px;
      grid-template-columns: 320px 1fr 360px;
    "
    data-areas="desktop"
  >
    <!-- Topbar -->
    <header
      style="grid-area: topbar"
      class="flex items-center gap-3 px-3 py-2 bg-gradient-to-b from-[#151a2a] to-[#111624] border-b border-border"
    >
      <div class="flex items-center gap-2 font-bold">
        <div
          class="w-6 h-6 rounded-md bg-gradient-to-br from-accent to-[#b28bff] grid place-items-center text-[#0a0d18] text-xs"
        >
          AR
        </div>
        <span>ApparentlyAR</span>
      </div>
      <div class="w-px h-7 bg-border mx-2"></div>

      <div class="flex items-center gap-2">
        <span class="text-sm text-muted">Project:</span>
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          My AR Viz
        </button>
      </div>

      <div class="flex items-center gap-2">
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Student
        </button>
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Teacher
        </button>
      </div>

      <div class="flex items-center gap-2">
        <button class="rounded-lg text-muted text-sm px-3 py-1.5">
          File
        </button>
        <button class="rounded-lg text-muted text-sm px-3 py-1.5">
          Edit
        </button>
        <button class="rounded-lg text-muted text-sm px-3 py-1.5">
          Share
        </button>
        <button class="rounded-lg text-muted text-sm px-3 py-1.5">
          Help
        </button>
      </div>

      <div class="w-px h-7 bg-border mx-2"></div>

      <!-- React Button Panel Mount Point -->
      <div id="buttons-root" class="flex items-center gap-2"></div>

      <div class="flex items-center gap-2">
        <span
          class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-[#1a2b24] text-ok border border-[#2e5a49] text-xs"
          >Camera: OK</span
        >
        <span
          class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
          >FPS: 28</span
        >
        <span
          class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
          >Markers: A,B</span
        >
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Enter AR
        </button>
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Simulate
        </button>
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Snapshot
        </button>
      </div>
    </header>

    <!-- Blocks Panel -->
    <aside
      style="grid-area: blocks"
      class="grid grid-rows-[40px,1fr] bg-panel border-r border-border"
    >
      <div
        class="flex gap-1.5 p-2 border-b border-border bg-panel sticky top-0"
      >
        <button
          class="px-3 py-1.5 rounded-md text-xs bg-[#253054] text-text border border-[#3b4a7a]"
        >
          Data
        </button>
        <button
          class="px-3 py-1.5 rounded-md text-xs bg-panel2 text-muted border border-border"
        >
          Transform
        </button>
        <button
          class="px-3 py-1.5 rounded-md text-xs bg-panel2 text-muted border border-border"
        >
          Visualize
        </button>
        <button
          class="px-3 py-1.5 rounded-md text-xs bg-panel2 text-muted border border-border"
        >
          AR Controls
        </button>
      </div>

      <div class="grid grid-rows-[auto,1fr] overflow-hidden">
        <div class="p-2 border-b border-border">
          <input
            class="w-full px-3 py-2 rounded-lg border border-border bg-[#0e1220] text-sm text-text placeholder-muted"
            placeholder="Search blocks..."
          />
        </div>
        
        <!-- Blockly Workspace -->
        <div id="blocklyDiv" class="w-full h-full overflow-hidden bg-[#0f1324]"></div>
        
        <!-- Hidden Blockly Toolbox -->
        <xml id="toolbox" style="display: none">
          <category name="Logic" colour="210">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
          </category>
          <category name="Loops" colour="120">
            <block type="controls_repeat_ext"></block>
            <block type="controls_whileUntil"></block>
          </category>
          <category name="Math" colour="230">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_round"></block>
            <block type="math_on_list"></block>
          </category>
          <category name="Text" colour="160">
            <block type="text"></block>
            <block type="text_print"></block>
          </category>
          <category name="Lists" colour="260">
            <block type="lists_create_with"></block>
            <block type="lists_getIndex"></block>
            <block type="lists_setIndex"></block>
            <block type="lists_length"></block>
          </category>
          <category name="Variables" colour="330" custom="VARIABLE"></category>
          <category name="Functions" colour="290" custom="PROCEDURE"></category>
          <category name="Data" colour="20">
            <block type="csv_import"></block>
            <block type="to_json">
              <value name="VALUE">
                <block type="csv_import"></block>
              </value>
            </block>
          </category>
        </xml>
      </div>
    </aside>

    <!-- Stage / Visualization Area -->
    <section
      style="grid-area: stage"
      class="relative grid grid-rows-[44px,1fr] bg-gradient-to-b from-[#0f1324] to-[#0b0f1c]"
    >
      <div
        class="flex items-center gap-2 p-2 border-b border-border bg-[#13182a]"
      >
        <div class="flex items-center gap-2">
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
            >View</span
          >
          <button
            class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
          >
            Bar
          </button>
          <button
            class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
          >
            Scatter
          </button>
          <button
            class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
          >
            Line
          </button>
        </div>
        
        <div id="react-controls-container" class="flex items-center gap-2"></div>

        <div class="ml-auto flex items-center gap-2">
          <button
            class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
          >
            Grid
          </button>
          <button
            class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
          >
            Link Marker
          </button>
        </div>
      </div>

      <!-- Visualization Container -->
      <div
        class="relative m-3 rounded-2xl border border-border overflow-hidden"
        style="
          background: conic-gradient(
            from 0deg at 50% 50%,
            #11182c,
            #121a31,
            #10172b,
            #11182c
          );
        "
      >
        <!-- React Chart Component Mount Point -->
        <div id="react-chart-container" class="w-full h-full min-h-[400px] grid place-items-center text-muted">
          <div class="text-sm text-muted">
            Visualization will appear here when blocks are executed
          </div>
        </div>
        
        <div class="absolute left-3 bottom-3 flex gap-2 flex-wrap">
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-[#1a2b24] text-ok border border-[#2e5a49] text-xs"
            >Marker A</span
          >
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-[#1a2b24] text-ok border border-[#2e5a49] text-xs"
            >Marker B</span
          >
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
            >Marker C</span
          >
        </div>
      </div>
    </section>

    <!-- Data Panel -->
    <aside
      style="grid-area: data"
      class="grid grid-rows-[44px,auto,1fr] bg-panel border-l border-border"
    >
      <div
        class="flex items-center gap-2 p-2 border-b border-border bg-[#151a2c]"
      >
        <strong>Data Panel</strong>
        <button class="ml-auto rounded-lg border border-border px-3 py-1.5 text-sm bg-panel text-text">
          Import CSV
        </button>
      </div>

      <div class="p-2 grid gap-1.5 border-b border-border">
        <div
          class="flex items-center justify-between gap-2 p-2 rounded-lg border border-border bg-panel2 text-sm"
        >
          <span>Sales.csv</span>
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
            >Rows: 1,240</span
          >
        </div>
        <div
          class="flex items-center justify-between gap-2 p-2 rounded-lg border border-border bg-panel2/60 text-sm opacity-80"
        >
          <span>Cities.csv</span>
          <span
            class="inline-flex items-center px-2 py-1 rounded-full bg-chip text-muted border border-border text-xs"
            >Rows: 200</span
          >
        </div>
      </div>

      <div class="overflow-auto p-2 grid gap-3">
        <div>
          <div
            class="text-[11px] uppercase tracking-wider text-muted mb-1.5"
          >
            Preview (first 50 rows)
          </div>
          <div class="overflow-auto rounded-lg border border-border">
            <table class="min-w-full text-xs">
              <thead class="bg-[#141a2e]">
                <tr>
                  <th class="border border-border px-2 py-1 text-left text-text">
                    Region (text)
                  </th>
                  <th class="border border-border px-2 py-1 text-left text-text">
                    Revenue (number)
                  </th>
                  <th class="border border-border px-2 py-1 text-left text-text">
                    Quarter (text)
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr class="odd:bg-[#12162a] even:bg-[#101426]">
                  <td class="border border-border px-2 py-1 text-text">North</td>
                  <td class="border border-border px-2 py-1 text-text">120000</td>
                  <td class="border border-border px-2 py-1 text-text">Q1</td>
                </tr>
                <tr class="odd:bg-[#12162a] even:bg-[#101426]">
                  <td class="border border-border px-2 py-1 text-text">South</td>
                  <td class="border border-border px-2 py-1 text-text">98000</td>
                  <td class="border border-border px-2 py-1 text-text">Q1</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="grid gap-2">
          <div
            class="text-[11px] uppercase tracking-wider text-muted mb-0.5"
          >
            Cleaning & Transform
          </div>
          <div class="grid gap-2">
            <div class="grid gap-1.5">
              <label class="text-xs text-muted"
                >Drop missing in columns</label
              >
              <input
                class="px-3 py-2 rounded-lg border border-border bg-[#0e1220] text-sm text-text placeholder-muted"
                placeholder="e.g., Revenue, Region"
              />
            </div>
            <div class="grid gap-1.5">
              <label class="text-xs text-muted">Convert type</label>
              <select
                class="px-3 py-2 rounded-lg border border-border bg-[#0e1220] text-sm text-text"
              >
                <option>Revenue → Number</option>
                <option>Quarter → Categorical</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Guide / Console -->
    <footer
      style="grid-area: guide"
      class="flex items-center gap-3 px-3 py-2 bg-[#111524] border-t border-border"
    >
      <div class="text-sm">
        Tutorial 2/6: Map columns to axes. Try setting X=Region, Y=Revenue.
      </div>
      
      <!-- React Output Display Mount Point -->
      <div id="output-root" class="flex-1"></div>
      
      <div class="ml-auto flex items-center gap-2">
        <!-- React Status Indicator Mount Point -->
        <div id="status-root"></div>
        
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Show Hint
        </button>
        <button
          class="rounded-lg border border-border bg-panel text-text text-sm px-3 py-1.5"
        >
          Next ▶
        </button>
      </div>
    </footer>
  </div>

  <script>
    // Enhanced workspace configuration with dark theme
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      grid: { 
        spacing: 20, 
        length: 3, 
        colour: '#2b3350', 
        snap: true 
      },
      zoom: { 
        controls: true, 
        wheel: true, 
        startScale: 0.8, 
        maxScale: 2, 
        minScale: 0.3, 
        scaleSpeed: 1.2 
      },
      move: { 
        scrollbars: true, 
        drag: true, 
        wheel: true 
      },
      trashcan: true,
      theme: {
        base: Blockly.Themes.Dark,
        componentStyles: {
          workspaceBackgroundColour: '#0f1324',
          toolboxBackgroundColour: '#171c2b',
          toolboxForegroundColour: '#e7ebff',
          flyoutBackgroundColour: '#171c2b',
          flyoutForegroundColour: '#e7ebff',
          flyoutOpacity: 0.8,
          scrollbarColour: '#2b3350',
          insertionMarkerColour: '#6ea8fe',
          insertionMarkerOpacity: 0.3
        }
      }
    });

    // Mobile device detection
    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    // Enhanced responsive workspace resizing function
    function resizeWorkspace() {
      if (workspace && document.getElementById('blocklyDiv')) {
        try {
          Blockly.svgResize(workspace);
          
          // Mobile-specific adjustments
          if (isMobile || window.innerWidth <= 768) {
            // Adjust workspace scale for mobile
            const scale = Math.max(0.6, Math.min(0.8, window.innerWidth / 1000));
            if (workspace.scale !== scale) {
              workspace.setScale(scale);
            }
          }
        } catch (error) {
          console.warn('Resize error:', error);
        }
      }
    }

    // Debounced resize function for better performance
    let resizeTimeout;
    function debouncedResize() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resizeWorkspace, 150);
    }

    // Add multiple resize event listeners
    window.addEventListener('resize', debouncedResize);
    window.addEventListener('orientationchange', () => {
      setTimeout(resizeWorkspace, 300); // Delay for orientation change
    });
    
    // Enhanced mobile touch handling
    if (isTouch) {
      document.addEventListener('touchstart', function() {}, { passive: true });
    }
    
    // Initial resize with mobile detection
    setTimeout(() => {
      resizeWorkspace();
      
      // Additional mobile initialization
      if (isMobile) {
        console.log('Mobile device detected, applying optimizations');
        const blocklyDiv = document.getElementById('blocklyDiv');
        if (blocklyDiv) {
          blocklyDiv.style.touchAction = 'pan-x pan-y';
        }
      }
    }, 100);

    // Cleanup function for proper workspace disposal
    let workspaceDisposed = false;
    function cleanupWorkspace() {
      if (workspace && !workspaceDisposed) {
        try {
          workspaceDisposed = true;
          workspace.dispose();
        } catch (error) {
          console.warn('Workspace disposal warning:', error);
        }
      }
    }

    // Add cleanup on page unload
    window.addEventListener('beforeunload', cleanupWorkspace);
    window.addEventListener('pagehide', cleanupWorkspace);

    // Bridge functions for React components to call vanilla JS Blockly functions
    window.executeBlocklyCode = function() {
      if (!workspace) return;
      
      // Update React state - executing
      if (window.reactSetExecuting) window.reactSetExecuting(true);
      if (window.reactSetOutput) window.reactSetOutput('');
      
      console.log('Run button clicked via React');
      
      try {
        console.log('Workspace blocks:', workspace.getAllBlocks().map(b => b.type));
        console.log('CSV import generator available:', !!Blockly.JavaScript['csv_import']);
        console.log('Calling workspaceToCode...');
        
        const code = Blockly.JavaScript.workspaceToCode(workspace);
        console.log('Generated code:', code);
        
        if (!code.trim()) {
          if (window.reactSetOutput) window.reactSetOutput('No code generated - make sure you have blocks in the workspace');
          if (window.reactSetError) window.reactSetError(false);
          if (window.reactSetExecuting) window.reactSetExecuting(false);
          return;
        }
        
        // eslint-disable-next-line no-eval
        const result = eval(code);
        console.log('Execution result:', result);
        
        if (window.reactSetOutput) window.reactSetOutput(result !== undefined ? String(result) : 'Code executed successfully');
        if (window.reactSetError) window.reactSetError(false);
      } catch (e) {
        console.error('Error details:', e);
        if (window.reactSetOutput) window.reactSetOutput(`Error: ${e.message}`);
        if (window.reactSetError) window.reactSetError(true);
      }
      
      // Update React state - finished executing
      if (window.reactSetExecuting) window.reactSetExecuting(false);
    };

    window.showBlocklyCode = function() {
      if (!workspace) return;
      
      console.log('Show code button clicked via React');
      console.log('Workspace blocks:', workspace.getAllBlocks().map(b => b.type));
      console.log('CSV import generator available:', !!Blockly.JavaScript['csv_import']);
      
      const code = Blockly.JavaScript.workspaceToCode(workspace);
      console.log('Generated code:', code);
      
      if (window.reactSetOutput) window.reactSetOutput(code || 'No code generated');
      if (window.reactSetError) window.reactSetError(false);
    };

    // External CSV upload handler - only add if element exists
    const csvUploadExternal = document.getElementById('csv-upload-external');
    if (csvUploadExternal) {
      csvUploadExternal.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            Papa.parse(event.target.result, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                Blockly.CsvImportData.data = results.data;
                Blockly.CsvImportData.filename = file.name;
                alert('CSV imported: ' + file.name + '\nRows: ' + results.data.length);
              }
            });
          };
          reader.readAsText(file);
        }
      });
    }
  </script>
  
  <!-- Include React bundle -->
  <script src="react-bundle.js"></script>
</body>
</html>