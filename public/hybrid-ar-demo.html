<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ApparentlyAR - Hybrid AR Demo (Markers + Hand Tracking)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- AR.js + A-Frame for marker detection -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- MediaPipe Hands for hand tracking -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248252/drawing_utils.js"></script>

  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Frontend API (provides window.AppApi with getCsv/list-files/etc.) -->
  <script src="../src/react/api.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }

    /* AR scene takes full screen */
    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }

    /* Hand overlay canvas */
    #hand-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 2;
    }

    /* Panels */
    .panel {
      position: fixed;
      width: 300px;
      background: rgba(42, 42, 42, 0.95);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #444;
      z-index: 3;
      max-height: 80vh;
      overflow-y: auto;
    }

    .panel h2 {
      margin-top: 0;
      color: #4CAF50;
      font-size: 18px;
    }

    .panel--left {
      top: 20px;
      left: 20px;
    }

    .panel--right {
      top: 20px;
      right: 20px;
    }

    @media (max-width: 900px) {
      .panel {
        width: calc(100vw - 40px);
        left: 20px;
        right: 20px;
      }
      .panel--left { top: 20px; }
      .panel--right { top: auto; bottom: 20px; }
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    .control-group select,
    .control-group input,
    .control-group button {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: white;
      font-size: 14px;
    }

    .control-group button {
      background: #4CAF50;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .control-group button:hover {
      background: #45a049;
    }

    .control-group button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 12px;
    }

    .status.ready {
      background: #4CAF50;
    }

    .status.detecting {
      background: #2196F3;
    }

    .status.error {
      background: #f44336;
    }

    .stats {
      background: #333;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
    }

    .stats h3 {
      margin-top: 0;
      color: #4CAF50;
      font-size: 14px;
    }

    .chart-list {
      max-height: 150px;
      overflow-y: auto;
    }

    .chart-item {
      background: #444;
      padding: 6px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .chart-item:hover {
      background: #555;
    }

    .chart-item.selected {
      background: #4CAF50;
    }

    .back-button {
      background: #666 !important;
      margin-bottom: 15px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: #555;
      outline: none;
      border-radius: 4px;
      height: 6px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #4CAF50;
      cursor: pointer;
      border-radius: 50%;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #4CAF50;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }

    input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }

    label {
      cursor: pointer;
      user-select: none;
    }

    /* Video mirroring */
    video.mirrored {
      transform: scaleX(-1);
    }

    .dev-state-readout {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 4px;
      padding: 8px;
      margin-top: 8px;
      font-size: 11px;
      line-height: 1.4;
    }

    .dev-state-readout div:last-child {
      margin-bottom: 0;
    }

    .dev-panel-note {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

    /* Light theme overrides to align with Blockly palette for AR overlay */
    :root {
      --background: #F8F9FA;
      --panel: rgba(255, 255, 255, 0.92);
      --border: #E5E7EB;
      --text: #1F2937;
      --muted: #6B7280;
      --primary: #22C55E;
      --primary-hover: #16A34A;
      --secondary: #4F46E5;
    }
    body { font-family: 'Plus Jakarta Sans', 'Segoe UI', Arial, sans-serif; color: var(--text); }
    .panel { background: var(--panel); border: 1px solid var(--border); color: var(--text); box-shadow: 0 8px 24px rgba(0,0,0,0.18); backdrop-filter: blur(6px); }
    .panel h2 { color: var(--text); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 10px; }
    .panel-toggle { width: 28px; height: 28px; border: 1px solid var(--border); background: #fff; color: var(--text); border-radius: 6px; cursor: pointer; line-height: 1; display: inline-flex; align-items: center; justify-content: center; }
    .panel.collapsed .panel-body { display: none; }
    .stats { background: #F9FAFB; border: 1px solid var(--border); }
    .stats h3 { color: var(--primary); }
    .control-group select, .control-group input, .control-group button { border: 1px solid var(--border); background: #FFFFFF; color: var(--text); }
    /* Fix checkbox alignment so it sits inline with its label text */
    .control-group input[type="checkbox"] { width: auto; display: inline-block; vertical-align: middle; margin-right: 8px; border: none; background: transparent; }
    .control-group button { background: var(--primary); color: #fff; }
    .control-group button:hover { background: var(--primary-hover); }
    .control-group button:disabled { background: #A3A3A3; }
    .status { border: 1px solid var(--border); background: #FFFFFF; color: var(--text); }
    .status.ready { background: rgba(34, 197, 94, 0.15); color: #065f46; border-color: rgba(34, 197, 94, 0.3); }
    .status.detecting { background: rgba(79, 70, 229, 0.15); color: #3730a3; border-color: rgba(79, 70, 229, 0.3); }
    .status.error { background: rgba(239, 68, 68, 0.15); color: #991b1b; border-color: rgba(239, 68, 68, 0.3); }
    .chart-item { background: #F3F4F6; }
    .chart-item:hover { background: #E5E7EB; }
    .chart-item.selected { background: rgba(34, 197, 94, 0.2); }
    .back-button { background: #FBBF24 !important; color: #1F2937 !important; border: 1px solid var(--border); }
    input[type="range"] { background: var(--border); }
    input[type="range"]::-webkit-slider-thumb { background: var(--primary); }
    input[type="range"]::-moz-range-thumb { background: var(--primary); }
    .dev-panel-note { color: var(--muted); }

  </style>
</head>

<body>
  <!-- AR.js A-Frame Scene -->
  <a-scene embedded
    arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_HAMMING63;"
    vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <!-- Assets for chart textures -->
    <a-assets>
      <canvas id="chart-texture-canvas" width="400" height="300"></canvas>
    </a-assets>

    <!-- AR World wrapper for scene-level mirroring -->
    <a-entity id="ar-world">
      <!-- Marker-based objects from Multi-AR-Example -->

      <!-- Marker 0: Dynamic chart plane anchored to marker (updated via ChartManager) -->
      <a-marker id="marker-0" type="barcode" value="0">
        <!-- Plane will be injected by script based on selected chart/data -->
        <!-- Hidden primitive kept to satisfy structure tests that expect a-box presence -->
        <a-box position="0 0 0" material="opacity: 0; transparent: true" scale="0 0 0"></a-box>
      </a-marker>

      <!-- Marker 1: Blue diamond (X-axis selector) -->
      <a-marker id="marker-1" type="barcode" value="1">
        <a-octahedron position="0 0 0" material="color: #2563eb; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 2: Green diamond (Y-axis selector) -->
      <a-marker id="marker-2" type="barcode" value="2">
        <a-octahedron position="0 0 0" material="color: #16a34a; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 3: Yellow diamond (Sort column selector) -->
      <a-marker id="marker-3" type="barcode" value="3">
        <a-octahedron position="0 0 0" material="color: #eab308; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 4: Orange diamond (Sort order selector) -->
      <a-marker id="marker-4" type="barcode" value="4">
        <a-octahedron position="0 0 0" material="color: #f97316; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 5: Purple diamond (Filter column selector) -->
      <a-marker id="marker-5" type="barcode" value="5">
        <a-octahedron position="0 0 0" material="color: #8b5cf6; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 6: Teal diamond (Filter value selector) -->
      <a-marker id="marker-6" type="barcode" value="6">
        <a-octahedron position="0 0 0" material="color: #14b8a6; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 7: Red diamond (Chart type selector) -->
      <a-marker id="marker-7" type="barcode" value="7">
        <a-octahedron position="0 0 0" material="color: #dc2626; opacity: 0.9"
          rotation="90 0 0" scale="0.4 1.5 0.4" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Hand-placed charts removed in pointer-tooltip mode -->
    </a-entity>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Hand landmarks overlay -->
  <canvas id="hand-overlay"></canvas>

  <!-- Dev mode chart overlay removed -->

  <!-- Left Panel: Status & Markers -->
  <div class="panel panel--left">
    <button class="back-button" onclick="window.location.href='/blockly'">
      ← Back to Blockly
    </button>
    <h2>Status & Markers</h2>

    <div class="control-group">
      <div id="status" class="status">Initializing...</div>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 14px;">Marker Detection</h3>
      <div id="marker-status" class="status ready">Ready for markers</div>
    </div>

    <div class="stats">
      <h3>Data Info</h3>
      <div id="data-info" style="font-size: 11px;">
        <div>Dataset: <span id="current-dataset">No data loaded</span></div>
        <div>Rows: <span id="current-rows">-</span></div>
        <div>Columns: <span id="current-columns">-</span></div>
      </div>
    </div>

    <div class="stats">
      <h3>Marker Controls & State</h3>
      <p style="font-size: 10px; margin: 5px 0 10px 0; line-height: 1.4;">
        <strong>Marker 0:</strong> Displays your data visualization<br>
        <strong>Markers 1-7:</strong> Rotate diamond dials to control chart<br>
        <strong>Hand Tracking:</strong> Point at marker 0 to show tooltips
      </p>
      <div style="display: grid; grid-template-columns: 155px 1fr; gap: 6px; font-size: 11px; line-height: 1.4;">
        <strong><span style="color: #2563eb;">●</span> X-Axis (M1):</strong>
        <span id="state-x-axis">-</span>

        <strong><span style="color: #16a34a;">●</span> Y-Axis (M2):</strong>
        <span id="state-y-axis">-</span>

        <strong><span style="color: #eab308;">●</span> Sort Column (M3):</strong>
        <span id="state-sort-column">-</span>

        <strong><span style="color: #f97316;">●</span> Sort Order (M4):</strong>
        <span id="state-sort-order">-</span>

        <strong><span style="color: #8b5cf6;">●</span> Filter Column (M5):</strong>
        <span id="state-filter-column">-</span>

        <strong><span style="color: #14b8a6;">●</span> Filter Value (M6):</strong>
        <span id="state-filter-value">-</span>

        <strong><span style="color: #dc2626;">●</span> Chart Type (M7):</strong>
        <span id="state-chart-type">-</span>

        <strong>Available Columns:</strong>
        <span id="state-columns">-</span>
      </div>
    </div>

    <div class="stats">
      <details>
        <summary style="cursor: pointer; color: var(--muted);">Performance</summary>
        <div id="performance-stats" style="font-size: 11px; margin-top: 6px;">
          <div>Process time: <span id="process-time">-</span>ms</div>
          <div>Video resolution: <span id="video-resolution">-</span></div>
        </div>
      </details>
    </div>

    <div class="stats">
      <details>
        <summary style="cursor: pointer; color: var(--muted);">Raycast Debug</summary>
        <div id="raycast-debug" style="font-size: 10px; font-family: monospace; margin-top: 6px;">
          <div>No data</div>
        </div>
      </details>
    </div>
  </div>

  <!-- Right Panel: Controls -->
  <div class="panel panel--right" id="controls-panel">
    <div class="panel-header">
      <h2 style="margin: 0;">AR Controls</h2>
      <button class="panel-toggle" aria-expanded="true" onclick="togglePanel('controls-panel', this)">−</button>
    </div>
    <div class="panel-body">

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 14px;">Hand Tracking</h3>
      <button id="start-hands">Start Hand Tracking</button>
      <button id="stop-hands" disabled>Stop Hand Tracking</button>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: #FF6B35; font-size: 14px;">Dev Mode</h3>
      <button id="spawn-mock-marker-chart" style="background: #ef4444; margin-bottom: 5px;">Spawn Marker Chart (No Paper)</button>
      <button id="remove-mock-marker-chart" style="background: #666;">Remove Marker Chart</button>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: var(--primary); font-size: 14px;">From Blockly</h3>
      <button id="load-from-blockly" style="background: #16A34A; margin-bottom: 6px;">Load Last Visualization</button>
      <button id="move-to-marker" style="background: #059669;">Put On Marker</button>
      <p style="font-size: 11px; color: #94a3b8; margin-top: 8px;">Data automatically loaded from most recent Blockly CSV</p>
    </div>

    <div class="stats">
      <details id="marker-test-panel">
        <summary style="cursor: pointer;">Chart Assignment (Manual)</summary>
        <p class="dev-panel-note">Use these controls to preview marker-driven chart configuration without physical markers.</p>
        <div class="control-group">
          <label for="dev-chart-type"><span style="color: #dc2626;">●</span> Chart Type (M7):</label>
          <select id="dev-chart-type">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="scatter">Scatter</option>
            <option value="pie">Pie</option>
          </select>
        </div>
        <div class="control-group">
          <label for="dev-x-axis"><span style="color: #2563eb;">●</span> X-Axis Column (M1):</label>
          <select id="dev-x-axis"></select>
        </div>
        <div class="control-group">
          <label for="dev-y-axis"><span style="color: #16a34a;">●</span> Y-Axis Column (M2):</label>
          <select id="dev-y-axis"></select>
        </div>
        <div class="control-group">
          <label for="dev-sort-column"><span style="color: #eab308;">●</span> Sort Column (M3):</label>
          <select id="dev-sort-column"></select>
        </div>
        <div class="control-group">
          <label for="dev-sort-order"><span style="color: #f97316;">●</span> Sort Order (M4):</label>
          <select id="dev-sort-order">
            <option value="ascending">Ascending</option>
            <option value="descending">Descending</option>
          </select>
        </div>
        <div class="control-group">
          <label for="dev-filter-column"><span style="color: #8b5cf6;">●</span> Filter Column (M5):</label>
          <select id="dev-filter-column"></select>
        </div>
        <div class="control-group">
          <label for="dev-filter-value"><span style="color: #14b8a6;">●</span> Filter Value (M6):</label>
          <select id="dev-filter-value" disabled>
            <option value="">Select a column first</option>
          </select>
        </div>
        <div class="control-group" style="display: flex; gap: 8px;">
          <button id="dev-refresh-columns" style="flex: 1;">Refresh Columns</button>
          <button id="dev-reset-config" style="flex: 1; background: #475569;">Reset</button>
        </div>
      </details>
    </div>

    <div class="stats">
      <details>
        <summary style="cursor: pointer; color: var(--muted);">Debug Controls</summary>
        <div class="control-group" style="margin-top: 6px;">
          <label>
            <input type="checkbox" id="debug-visualization" checked onchange="setDebugVisualization(this.checked)">
            Show Debug Crosshair
          </label>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="mirror-video" checked onchange="setVideoMirroring(this.checked)">
            Mirror Video Feed
          </label>
        </div>
      </details>
    </div>

    <div class="stats">
      <details open>
        <summary style="cursor: pointer; color: var(--muted);">Point Controls Calibration</summary>
        <div class="control-group" style="margin-top: 6px;">
          <label for="calibration-x">X Offset: <span id="calibration-x-value">0.0</span></label>
          <input type="range" id="calibration-x" min="-10" max="10" value="0" step="0.5"
            oninput="updateCalibration()" style="width: 100%; margin-bottom: 8px;">

          <label for="calibration-y">Y Offset: <span id="calibration-y-value">0.0</span></label>
          <input type="range" id="calibration-y" min="-10" max="10" value="0" step="0.5"
            oninput="updateCalibration()" style="width: 100%; margin-bottom: 8px;">

          <button onclick="resetCalibrationUI()" style="width: 100%; background: #666; color: #fff;">Reset Calibration</button>
        </div>
      </details>
    </div>
    </div>
  </div>

  <script>
    // Calibration UI functions
    function updateCalibration() {
      const x = parseFloat(document.getElementById('calibration-x').value);
      const y = parseFloat(document.getElementById('calibration-y').value);
      document.getElementById('calibration-x-value').textContent = (x / 10).toFixed(1);
      document.getElementById('calibration-y-value').textContent = (y / 10).toFixed(1);
      setCalibration(x / 10, y / 10);
    }

    function resetCalibrationUI() {
      document.getElementById('calibration-x').value = 0;
      document.getElementById('calibration-y').value = 0;
      document.getElementById('calibration-x-value').textContent = '0.0';
      document.getElementById('calibration-y-value').textContent = '0.0';
      resetCalibration();
    }

    // Load saved calibration on page load
    window.addEventListener('load', () => {
      const savedX = localStorage.getItem('ar_calibration_x');
      const savedY = localStorage.getItem('ar_calibration_y');
      if (savedX !== null) {
        const x = parseFloat(savedX);
        document.getElementById('calibration-x').value = x * 10;
        document.getElementById('calibration-x-value').textContent = x.toFixed(1);
      }
      if (savedY !== null) {
        const y = parseFloat(savedY);
        document.getElementById('calibration-y').value = y * 10;
        document.getElementById('calibration-y-value').textContent = y.toFixed(1);
      }
    });

    // Collapsible panel helper
    function togglePanel(panelId, btn) {
      const panel = document.getElementById(panelId);
      if (!panel) return;
      panel.classList.toggle('collapsed');
      const isCollapsed = panel.classList.contains('collapsed');
      if (btn) {
        btn.setAttribute('aria-expanded', String(!isCollapsed));
        btn.textContent = isCollapsed ? '+' : '−';
      }
    }
  </script>

  <script>
    (function () {
      const panel = {
        initialized: false,
        waiting: false,
        init() {
          if (this.initialized) return;
          const controller = window.markerInteractionController;
          if (!controller) {
            if (!this.waiting) {
              this.waiting = true;
              setTimeout(() => {
                this.waiting = false;
                this.init();
              }, 200);
            }
            return;
          }

          this.initialized = true;
          this.controller = controller;
          this.typeSelect = document.getElementById('dev-chart-type');
          this.xSelect = document.getElementById('dev-x-axis');
          this.ySelect = document.getElementById('dev-y-axis');
          this.sortColumnSelect = document.getElementById('dev-sort-column');
          this.sortOrderSelect = document.getElementById('dev-sort-order');
          this.filterColumnSelect = document.getElementById('dev-filter-column');
          this.filterValueSelect = document.getElementById('dev-filter-value');
          this.refreshBtn = document.getElementById('dev-refresh-columns');
          this.resetBtn = document.getElementById('dev-reset-config');

          if (this.typeSelect) {
            this.typeSelect.addEventListener('change', () => {
              this.controller.setChartType(this.typeSelect.value);
            });
          }

          if (this.xSelect) {
            this.xSelect.addEventListener('change', () => {
              if (this.xSelect.value) {
                this.controller.setXAxisColumn(this.xSelect.value);
              }
            });
          }

          if (this.ySelect) {
            this.ySelect.addEventListener('change', () => {
              if (this.ySelect.value) {
                this.controller.setYAxisColumn(this.ySelect.value);
              }
            });
          }

          if (this.sortColumnSelect) {
            this.sortColumnSelect.addEventListener('change', () => {
              if (this.sortColumnSelect.value) {
                this.controller.setSortColumn(this.sortColumnSelect.value);
              }
            });
          }

          if (this.sortOrderSelect) {
            this.sortOrderSelect.addEventListener('change', () => {
              this.controller.setSortOrder(this.sortOrderSelect.value || 'ascending');
            });
          }

          if (this.filterColumnSelect) {
            this.filterColumnSelect.addEventListener('change', () => {
              console.log('[TestPanel:FilterChange] User changed filter column dropdown');
              console.log('[TestPanel:FilterChange] Current dropdown value:', this.filterColumnSelect.value);
              const selected = this.filterColumnSelect.value;
              console.log('[TestPanel:FilterChange] Selected value (after normalization):', selected);
              console.log('[TestPanel:FilterChange] Calling controller.setFilterColumn with:', selected || null);
              this.controller.setFilterColumn(selected || null);
              console.log('[TestPanel:FilterChange] Calling populateFilterValues with column:', selected || null);
              this.populateFilterValues(selected || null, null);
              console.log('[TestPanel:FilterChange] Filter change handler complete, dropdown value now:', this.filterColumnSelect.value);
            });
          }

          if (this.filterValueSelect) {
            this.filterValueSelect.addEventListener('change', () => {
              this.controller.setFilterValue(this.filterValueSelect.value);
            });
          }

          if (this.refreshBtn) {
            this.refreshBtn.addEventListener('click', () => {
              this.controller.refreshAvailableColumns();
              if (typeof this.controller.getStateSnapshot === 'function') {
                this.applyState(this.controller.getStateSnapshot());
              }
            });
          }

          if (this.resetBtn) {
            this.resetBtn.addEventListener('click', () => {
              if (typeof this.controller.resetConfiguration === 'function') {
                this.controller.resetConfiguration();
              }
            });
          }

          if (typeof this.controller.getStateSnapshot === 'function') {
            // Force immediate refresh if columns already loaded
            if (this.controller.availableColumns && this.controller.availableColumns.length > 0) {
              console.log('[MarkerTestPanel] Columns already loaded on init, applying state');
              this.applyState(this.controller.getStateSnapshot());
            } else {
              this.applyState(this.controller.getStateSnapshot());
            }
          }
        },
        populateColumns(columns) {
          const list = Array.isArray(columns) ? columns : [];
          const selects = [
            { element: this.xSelect, fallbackIndex: 0 },
            { element: this.ySelect, fallbackIndex: 1 },
            { element: this.sortColumnSelect, fallbackIndex: 0 }
          ];

          selects.forEach(({ element, fallbackIndex }) => {
            if (!element) return;
            const previous = element.value;
            element.innerHTML = '';

            if (!list.length) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = 'No columns available';
              element.appendChild(opt);
              element.disabled = true;
              return;
            }

            element.disabled = false;
            list.forEach((column) => {
              const option = document.createElement('option');
              option.value = column;
              option.textContent = column;
              element.appendChild(option);
            });

            if (previous && list.includes(previous)) {
              element.value = previous;
            } else if (list[fallbackIndex]) {
              element.value = list[fallbackIndex];
            } else {
              element.value = list[0];
            }
          });

          if (this.filterColumnSelect) {
            console.log('[TestPanel:PopulateColumns] Repopulating filter column dropdown');
            const previous = this.filterColumnSelect.value;
            console.log('[TestPanel:PopulateColumns] Previous filter dropdown value:', previous);
            console.log('[TestPanel:PopulateColumns] Available columns to populate:', list);
            this.filterColumnSelect.innerHTML = '';

            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = 'No filter';
            this.filterColumnSelect.appendChild(noneOption);

            if (!list.length) {
              console.log('[TestPanel:PopulateColumns] No columns available, disabling filter dropdown');
              const placeholder = document.createElement('option');
              placeholder.value = '';
              placeholder.textContent = 'No columns available';
              placeholder.disabled = true;
              this.filterColumnSelect.appendChild(placeholder);
              this.filterColumnSelect.disabled = true;
              this.filterColumnSelect.value = '';
              return;
            }

            this.filterColumnSelect.disabled = false;
            list.forEach((column) => {
              const option = document.createElement('option');
              option.value = column;
              option.textContent = column;
              this.filterColumnSelect.appendChild(option);
            });

            if (previous && list.includes(previous)) {
              console.log('[TestPanel:PopulateColumns] Restoring previous value:', previous);
              this.filterColumnSelect.value = previous;
            } else {
              console.log('[TestPanel:PopulateColumns] Previous value not in list or empty, resetting to ""');
              this.filterColumnSelect.value = '';
            }
            console.log('[TestPanel:PopulateColumns] Final filter dropdown value after populate:', this.filterColumnSelect.value);
          }
        },
        hasOption(select, value) {
          if (!select) return false;
          const normalized = value === undefined || value === null ? '' : String(value);
          return Array.from(select.options).some((option) => option.value === normalized);
        },
        populateFilterValues(column, selectedValue) {
          console.log('[TestPanel:PopulateValues] === populateFilterValues called ===');
          console.log('[TestPanel:PopulateValues] Column:', column);
          console.log('[TestPanel:PopulateValues] Selected value:', selectedValue);
          if (!this.filterValueSelect) {
            console.log('[TestPanel:PopulateValues] filterValueSelect not found, returning');
            return;
          }

          const select = this.filterValueSelect;
          select.innerHTML = '';

          if (!column) {
            console.log('[TestPanel:PopulateValues] No column specified, disabling filter value dropdown');
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select a column first';
            select.appendChild(placeholder);
            select.disabled = true;
            select.value = '';
            return;
          }

          const values = typeof this.controller?.getFilterValuesForColumn === 'function'
            ? this.controller.getFilterValuesForColumn(column)
            : [];
          console.log('[TestPanel:PopulateValues] Available values for column:', values);

          select.disabled = false;

          const allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = 'All values';
          select.appendChild(allOption);

          if (!values.length) {
            console.log('[TestPanel:PopulateValues] No values found for column');
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'No values found';
            placeholder.disabled = true;
            select.appendChild(placeholder);
            select.value = '';
            return;
          }

          values.forEach((value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
          });

          const normalized = selectedValue === undefined || selectedValue === null ? '' : String(selectedValue);
          console.log('[TestPanel:PopulateValues] Normalized selected value:', normalized);
          if (this.hasOption(select, normalized)) {
            console.log('[TestPanel:PopulateValues] Setting filter value dropdown to:', normalized);
            select.value = normalized;
          } else {
            console.log('[TestPanel:PopulateValues] Selected value not in options, resetting to ""');
            select.value = '';
          }
          console.log('[TestPanel:PopulateValues] Final filter value dropdown value:', select.value);
        },
        applyState(state = {}) {
          console.log('[TestPanel:ApplyState] === applyState called ===');
          console.log('[TestPanel:ApplyState] Full state object:', state);
          console.log('[TestPanel:ApplyState] Filter column in state:', state.filterColumn);
          console.log('[TestPanel:ApplyState] Filter value in state:', state.filterValue);
          if (!this.initialized) return;

          const columns = Array.isArray(state.availableColumns) ? state.availableColumns : [];
          console.log('[TestPanel:ApplyState] Available columns from state:', columns);

          // Only repopulate columns if they've changed (prevents dropdown resets)
          const columnsChanged = !this._lastColumns ||
            JSON.stringify(this._lastColumns) !== JSON.stringify(columns);
          console.log('[TestPanel:ApplyState] Columns changed?', columnsChanged);
          console.log('[TestPanel:ApplyState] Previous columns:', this._lastColumns);
          console.log('[TestPanel:ApplyState] New columns:', columns);

          if (columnsChanged) {
            console.log('[TestPanel:ApplyState] Calling populateColumns (this will reset dropdowns)');
            this.populateColumns(columns);
            this._lastColumns = [...columns];
          }

          if (this.typeSelect && state.chartType) {
            if (!this.hasOption(this.typeSelect, state.chartType)) {
              const option = document.createElement('option');
              option.value = state.chartType;
              option.textContent = state.chartType;
              this.typeSelect.appendChild(option);
            }
            this.typeSelect.value = state.chartType;
          }

          if (this.xSelect && this.hasOption(this.xSelect, state.xColumn)) {
            this.xSelect.value = state.xColumn;
          }

          if (this.ySelect && this.hasOption(this.ySelect, state.yColumn)) {
            this.ySelect.value = state.yColumn;
          }

          if (this.sortColumnSelect) {
            if (this.hasOption(this.sortColumnSelect, state.sortColumn)) {
              this.sortColumnSelect.value = state.sortColumn;
            } else if (!this.sortColumnSelect.value && this.sortColumnSelect.options.length) {
              this.sortColumnSelect.value = this.sortColumnSelect.options[0].value;
            }
          }

          if (this.sortOrderSelect) {
            this.sortOrderSelect.value = state.sortOrder || 'ascending';
          }

          if (this.filterColumnSelect) {
            console.log('[TestPanel:ApplyState] Setting filter column dropdown value');
            console.log('[TestPanel:ApplyState] Current dropdown value before set:', this.filterColumnSelect.value);
            const targetColumn = state.filterColumn || '';
            console.log('[TestPanel:ApplyState] Target column to set:', targetColumn);
            const hasOption = this.hasOption(this.filterColumnSelect, targetColumn);
            console.log('[TestPanel:ApplyState] hasOption check result:', hasOption);
            if (hasOption) {
              console.log('[TestPanel:ApplyState] Setting dropdown to:', targetColumn);
              this.filterColumnSelect.value = targetColumn;
            } else {
              console.log('[TestPanel:ApplyState] Target not in options, resetting to ""');
              this.filterColumnSelect.value = '';
            }
            console.log('[TestPanel:ApplyState] Dropdown value after set:', this.filterColumnSelect.value);
          }

          console.log('[TestPanel:ApplyState] Calling populateFilterValues with:', state.filterColumn || null, state.filterValue ?? null);
          this.populateFilterValues(state.filterColumn || null, state.filterValue ?? null);
          console.log('[TestPanel:ApplyState] Filter dropdown value after populateFilterValues:', this.filterColumnSelect?.value);
        }
      };

      window.MarkerTestPanel = panel;

      window.addEventListener('markerInteractionStateChange', (event) => {
        console.log('[TestPanel:EventListener] ======================================');
        console.log('[TestPanel:EventListener] markerInteractionStateChange event fired');
        console.log('[TestPanel:EventListener] Event detail:', event?.detail);
        console.log('[TestPanel:EventListener] Filter column from event:', event?.detail?.filterColumn);
        console.log('[TestPanel:EventListener] Filter value from event:', event?.detail?.filterValue);
        console.log('[TestPanel:EventListener] Current filter dropdown value before applyState:', panel.filterColumnSelect?.value);
        panel.init();
        if (panel.initialized) {
          panel.applyState(event.detail || {});
        }
        console.log('[TestPanel:EventListener] Current filter dropdown value after applyState:', panel.filterColumnSelect?.value);
        console.log('[TestPanel:EventListener] ======================================');
      });

      window.addEventListener('load', () => {
        setTimeout(() => panel.init(), 300);
      });
    })();
  </script>

  <script>
    (function () {
      const refs = {
        x: document.getElementById('state-x-axis'),
        y: document.getElementById('state-y-axis'),
        sortColumn: document.getElementById('state-sort-column'),
        sortOrder: document.getElementById('state-sort-order'),
        filterColumn: document.getElementById('state-filter-column'),
        filterValue: document.getElementById('state-filter-value'),
        chartType: document.getElementById('state-chart-type'),
        columns: document.getElementById('state-columns')
      };

      if (!refs.x) {
        return;
      }

      const capitalize = (value) => {
        if (!value || typeof value !== 'string') return '-';
        return value.charAt(0).toUpperCase() + value.slice(1);
      };

      const update = (detail = {}) => {
        refs.x.textContent = detail.xColumn || '-';
        refs.y.textContent = detail.yColumn || '-';
        refs.sortColumn.textContent = detail.sortColumn || '-';
        refs.sortOrder.textContent = detail.sortOrder ? capitalize(detail.sortOrder) : '-';

        // Split filter into column and value
        refs.filterColumn.textContent = detail.filterColumn || 'None';
        refs.filterValue.textContent = detail.filterValue || 'All values';

        refs.chartType.textContent = detail.chartType ? capitalize(detail.chartType) : '-';
        refs.columns.textContent = Array.isArray(detail.availableColumns) && detail.availableColumns.length
          ? detail.availableColumns.join(', ')
          : 'None';
      };

      window.addEventListener('markerInteractionStateChange', (event) => {
        update(event?.detail || {});
      });

      update({});
    })();
  </script>

  <!-- AR JavaScript modules -->
  <script src="../src/ar/coordinate-system.js"></script>
  <script src="../src/ar/gesture-detector.js"></script>
  <script src="../src/ar/chart-manager.js"></script>
  <script src="../src/ar/hand-tracking.js"></script>
  <script src="../src/ar/marker-interaction-controller.js"></script>
  <script src="../src/ar/hybrid-ar-controller.js"></script>
</body>

</html>
