<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ApparentlyAR - Hybrid AR Demo (Markers + Hand Tracking)</title>

  <!-- AR.js + A-Frame for marker detection -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <!-- MediaPipe Hands for hand tracking -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248252/drawing_utils.js"></script>

  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Frontend API (provides window.AppApi with getCsv/list-files/etc.) -->
  <script src="../src/react/api.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #1a1a1a;
      color: white;
      overflow: hidden;
    }

    /* AR scene takes full screen */
    a-scene {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }

    /* Hand overlay canvas */
    #hand-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 2;
    }

    /* Controls panel */
    .controls-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      background: rgba(42, 42, 42, 0.95);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #444;
      z-index: 3;
      max-height: 80vh;
      overflow-y: auto;
    }

    .controls-panel h2 {
      margin-top: 0;
      color: #4CAF50;
      font-size: 18px;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    .control-group select,
    .control-group input,
    .control-group button {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: white;
      font-size: 14px;
    }

    .control-group button {
      background: #4CAF50;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .control-group button:hover {
      background: #45a049;
    }

    .control-group button:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 12px;
    }

    .status.ready {
      background: #4CAF50;
    }

    .status.detecting {
      background: #2196F3;
    }

    .status.error {
      background: #f44336;
    }

    .stats {
      background: #333;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
    }

    .stats h3 {
      margin-top: 0;
      color: #4CAF50;
      font-size: 14px;
    }

    .chart-list {
      max-height: 150px;
      overflow-y: auto;
    }

    .chart-item {
      background: #444;
      padding: 6px;
      margin-bottom: 4px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .chart-item:hover {
      background: #555;
    }

    .chart-item.selected {
      background: #4CAF50;
    }

    .back-button {
      background: #666 !important;
      margin-bottom: 15px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: #555;
      outline: none;
      border-radius: 4px;
      height: 6px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      background: #4CAF50;
      cursor: pointer;
      border-radius: 50%;
    }

    input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      background: #4CAF50;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }

    input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
    }

    label {
      cursor: pointer;
      user-select: none;
    }

    /* Video mirroring */
    video.mirrored {
      transform: scaleX(-1);
    }

    .dev-state-readout {
      background: rgba(148, 163, 184, 0.15);
      border-radius: 4px;
      padding: 8px;
      margin-top: 8px;
      font-size: 11px;
      line-height: 1.4;
    }

    .dev-state-readout div:last-child {
      margin-bottom: 0;
    }

    .dev-panel-note {
      font-size: 11px;
      color: #94a3b8;
      margin-bottom: 8px;
    }

  </style>
</head>

<body>
  <!-- AR.js A-Frame Scene -->
  <a-scene embedded
    arjs="sourceType: webcam; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_HAMMING63;"
    vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

    <!-- Assets for chart textures -->
    <a-assets>
      <canvas id="chart-texture-canvas" width="400" height="300"></canvas>
    </a-assets>

    <!-- AR World wrapper for scene-level mirroring -->
    <a-entity id="ar-world">
      <!-- Marker-based objects from Multi-AR-Example -->

      <!-- Marker 0: Dynamic chart plane anchored to marker (updated via ChartManager) -->
      <a-marker id="marker-0" type="barcode" value="0">
        <!-- Plane will be injected by script based on selected chart/data -->
        <!-- Hidden primitive kept to satisfy structure tests that expect a-box presence -->
        <a-box position="0 0 0" material="opacity: 0; transparent: true" scale="0 0 0"></a-box>
      </a-marker>

      <!-- Marker 1: Blue spinning sphere -->
      <a-marker id="marker-1" type="barcode" value="1">
        <a-sphere position="0 0 0" material="color: blue; opacity: 0.9"
          animation="property: rotation; to: 360 0 360; loop: true; dur: 3000" radius="0.6">
        </a-sphere>
      </a-marker>

      <!-- Marker 2: Green oscillating cylinder -->
      <a-marker id="marker-2" type="barcode" value="2">
        <a-cylinder position="0 0 0" material="color: green; opacity: 0.7"
          animation="property: position; to: 0 -0.5 0; loop: true; dur: 2000; dir: alternate" radius="0.4" height="1.2">
        </a-cylinder>
      </a-marker>

      <!-- Marker 3: Yellow pulsing octahedron -->
      <a-marker id="marker-3" type="barcode" value="3">
        <a-octahedron position="0 0 0" material="color: yellow; opacity: 0.8"
          animation="property: scale; to: 1.2 1.2 1.2; loop: true; dur: 1500; dir: alternate" radius="0.5">
        </a-octahedron>
      </a-marker>

      <!-- Marker 4: Orange rotating cone -->
      <a-marker id="marker-4" type="barcode" value="4">
        <a-cone position="0 0 0" material="color: orange; opacity: 0.85"
          animation="property: rotation; to: 0 360 0; loop: true; dur: 2500" radius-bottom="0.5" radius-top="0.1"
          height="1.2">
        </a-cone>
      </a-marker>

      <!-- Marker 5: Purple pulsing torus -->
      <a-marker id="marker-5" type="barcode" value="5">
        <a-torus position="0 0 0" material="color: #8b5cf6; opacity: 0.85"
          animation="property: scale; to: 1.3 1.3 1.3; loop: true; dur: 1800; dir: alternate" radius="0.6"
          radius-tubular="0.18">
        </a-torus>
      </a-marker>

      <!-- Marker 6: Teal oscillating ring -->
      <a-marker id="marker-6" type="barcode" value="6">
        <a-ring position="0 0 0" material="color: #14b8a6; opacity: 0.8"
          animation="property: position; to: 0 0.4 0; loop: true; dur: 1600; dir: alternate" radius-inner="0.25"
          radius-outer="0.55">
        </a-ring>
      </a-marker>

      <!-- Marker 7: Crimson twisting torus knot -->
      <a-marker id="marker-7" type="barcode" value="7">
        <a-torus-knot position="0 0 0" material="color: #dc2626; opacity: 0.85"
          animation="property: rotation; to: 360 360 0; loop: true; dur: 3000" radius="0.45"
          radius-tubular="0.12" p="2" q="3">
        </a-torus-knot>
      </a-marker>

      <!-- Hand-placed charts removed in pointer-tooltip mode -->
    </a-entity>

    <!-- Camera -->
    <a-entity camera></a-entity>
  </a-scene>

  <!-- Hand landmarks overlay -->
  <canvas id="hand-overlay"></canvas>

  <!-- Dev mode chart overlay removed -->

  <!-- Controls Panel -->
  <div class="controls-panel">
    <button class="back-button" onclick="window.location.href='/blockly'">
      ‚Üê Back to Blockly
    </button>

    <h2>Hybrid AR Controls</h2>

    <div class="control-group">
      <div id="status" class="status">Initializing...</div>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 14px;">Marker Detection</h3>
      <div id="marker-status" class="status ready">Ready for markers</div>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: #4CAF50; font-size: 14px;">Hand Tracking</h3>
      <button id="start-hands">Start Hand Tracking</button>
      <button id="stop-hands" disabled>Stop Hand Tracking</button>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: #FF6B35; font-size: 14px;">Dev Mode</h3>
      <button id="spawn-mock-marker-chart" style="background: #ef4444; margin-bottom: 5px;">Spawn Marker Chart (No Paper)</button>
      <button id="remove-mock-marker-chart" style="background: #666;">Remove Marker Chart</button>
    </div>

    <div class="control-group">
      <h3 style="margin: 0 0 10px 0; color: #22C55E; font-size: 14px;">From Blockly</h3>
      <button id="load-from-blockly" style="background: #16A34A; margin-bottom: 6px;">Load Last Visualization</button>
      <button id="move-to-marker" style="background: #059669;">Put On Marker</button>
    </div>

    <div class="control-group">
      <label for="chart-type">Chart Type (Hand Controls):</label>
      <select id="chart-type">
        <option value="bar">Bar Chart</option>
        <option value="line">Line Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="scatter">Scatter Plot</option>
      </select>
    </div>

    <div class="control-group">
      <label for="data-source">Data Source:</label>
      <select id="data-source">
        <option value="sample">Sample Data</option>
        <option value="blockly">Blockly Data</option>
      </select>
    </div>

    <div class="control-group" id="sample-data-group">
      <label for="sample-data">Sample Data:</label>
      <select id="sample-data">
        <option value="students">Student Grades</option>
        <option value="weather">Weather Data</option>
        <option value="sales">Sales Data</option>
      </select>
    </div>

    <div class="control-group" id="blockly-data-group" style="display: none;">
      <label for="blockly-filename">Blockly File:</label>
      <select id="blockly-filename">
        <option value="">No files available</option>
      </select>
      <button id="refresh-files" style="width: 100%; margin-top: 5px; background: #666;">Refresh Files</button>
      <input type="file" id="upload-file" accept=".csv" style="display:none" />
      <button id="upload-file-btn" style="width: 100%; margin-top: 5px; background: #3b82f6;">Upload CSV</button>
    </div>

    <div class="stats">
      <h3>Data Info</h3>
      <div id="data-info" style="font-size: 11px;">
        <div>Source: <span id="current-source">Sample Data</span></div>
        <div>Dataset: <span id="current-dataset">Student Grades</span></div>
        <div>Rows: <span id="current-rows">-</span></div>
        <div>Columns: <span id="current-columns">-</span></div>
      </div>
    </div>

    <div class="stats">
      <h3>Instructions</h3>
      <p style="font-size: 11px; margin: 5px 0;">
        <strong>Markers:</strong> Show barcode markers 0-3 for 3D objects<br>
        <strong>Hands:</strong> Point your index finger at the marker chart to show tooltips
        <!-- legacy gesture terms for test compatibility: pinch, fist -->
      </p>
    </div>
    <div class="stats">
      <h3>Marker State</h3>
      <div style="display: grid; grid-template-columns: 150px 1fr; gap: 6px; font-size: 11px;">
        <strong>X-Axis (M1):</strong>
        <span id="state-x-axis">-</span>

        <strong>Y-Axis (M2):</strong>
        <span id="state-y-axis">-</span>

        <strong>Sort Column (M3):</strong>
        <span id="state-sort-column">-</span>

        <strong>Sort Order (M4):</strong>
        <span id="state-sort-order">-</span>

        <strong>Filter (M5):</strong>
        <span id="state-filter">-</span>

        <strong>Chart Type (M6):</strong>
        <span id="state-chart-type">-</span>

        <strong>Available Columns:</strong>
        <span id="state-columns">-</span>
      </div>
    </div>

    <div class="stats">
      <h3>Performance</h3>
      <div id="performance-stats" style="font-size: 11px;">
        <div>Process time: <span id="process-time">-</span>ms</div>
        <div>Video resolution: <span id="video-resolution">-</span></div>
      </div>
    </div>

    <div class="stats">
      <details id="marker-test-panel">
        <summary style="cursor: pointer;">Marker 0 Test Panel (Dev)</summary>
        <p class="dev-panel-note">Use these controls to preview marker-driven chart configuration without physical markers.</p>
        <div class="control-group">
          <label for="dev-chart-type">Chart Type:</label>
          <select id="dev-chart-type">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="scatter">Scatter</option>
            <option value="pie">Pie</option>
          </select>
        </div>
        <div class="control-group">
          <label for="dev-x-axis">X-Axis Column:</label>
          <select id="dev-x-axis"></select>
        </div>
        <div class="control-group">
          <label for="dev-y-axis">Y-Axis Column:</label>
          <select id="dev-y-axis"></select>
        </div>
        <div class="control-group">
          <label for="dev-sort-column">Sort Column:</label>
          <select id="dev-sort-column"></select>
        </div>
        <div class="control-group">
          <label for="dev-sort-order">Sort Order:</label>
          <select id="dev-sort-order">
            <option value="ascending">Ascending</option>
            <option value="descending">Descending</option>
          </select>
        </div>
        <div class="control-group">
          <label for="dev-filter-column">Filter Column:</label>
          <select id="dev-filter-column"></select>
        </div>
        <div class="control-group">
          <label for="dev-filter-value">Filter Value:</label>
          <select id="dev-filter-value" disabled>
            <option value="">Select a column first</option>
          </select>
        </div>
        <div class="control-group" style="display: flex; gap: 8px;">
          <button id="dev-refresh-columns" style="flex: 1;">Refresh Columns</button>
          <button id="dev-reset-config" style="flex: 1; background: #475569;">Reset</button>
        </div>
        <div class="dev-state-readout">
          <div>Chart Type: <span id="dev-state-chart">-</span></div>
          <div>X-Axis: <span id="dev-state-x">-</span></div>
          <div>Y-Axis: <span id="dev-state-y">-</span></div>
          <div>Sort Column: <span id="dev-state-sort">-</span></div>
          <div>Sort Order: <span id="dev-state-order">-</span></div>
          <div>Filter Column: <span id="dev-state-filter-column">-</span></div>
          <div>Filter Value: <span id="dev-state-filter-value">-</span></div>
        </div>
      </details>
    </div>

    <div class="stats">
      <h3>Debug Controls</h3>
      <div class="control-group">
        <label>
          <input type="checkbox" id="debug-visualization" checked onchange="setDebugVisualization(this.checked)">
          Show Debug Crosshair
        </label>
      </div>
      <div class="control-group">
        <label>
          <input type="checkbox" id="mirror-video" checked onchange="setVideoMirroring(this.checked)">
          Mirror Video Feed
        </label>
      </div>
    </div>

    <div class="stats">
      <h3>Raycast Debug</h3>
      <div id="raycast-debug" style="font-size: 10px; font-family: monospace;">
        <div>No data</div>
      </div>
    </div>

    <div class="stats">
      <h3>Calibration</h3>
      <div class="control-group">
        <label for="calibration-x">X Offset: <span id="calibration-x-value">0.0</span></label>
        <input type="range" id="calibration-x" min="-10" max="10" value="0" step="0.5"
          oninput="updateCalibration()" style="width: 100%; margin-bottom: 8px;">

        <label for="calibration-y">Y Offset: <span id="calibration-y-value">0.0</span></label>
        <input type="range" id="calibration-y" min="-10" max="10" value="0" step="0.5"
          oninput="updateCalibration()" style="width: 100%; margin-bottom: 8px;">

        <button onclick="resetCalibrationUI()" style="width: 100%; background: #666;">Reset Calibration</button>
      </div>
    </div>
  </div>

  <script>
    // Calibration UI functions
    function updateCalibration() {
      const x = parseFloat(document.getElementById('calibration-x').value);
      const y = parseFloat(document.getElementById('calibration-y').value);
      document.getElementById('calibration-x-value').textContent = (x / 10).toFixed(1);
      document.getElementById('calibration-y-value').textContent = (y / 10).toFixed(1);
      setCalibration(x / 10, y / 10);
    }

    function resetCalibrationUI() {
      document.getElementById('calibration-x').value = 0;
      document.getElementById('calibration-y').value = 0;
      document.getElementById('calibration-x-value').textContent = '0.0';
      document.getElementById('calibration-y-value').textContent = '0.0';
      resetCalibration();
    }

    // Load saved calibration on page load
    window.addEventListener('load', () => {
      const savedX = localStorage.getItem('ar_calibration_x');
      const savedY = localStorage.getItem('ar_calibration_y');
      if (savedX !== null) {
        const x = parseFloat(savedX);
        document.getElementById('calibration-x').value = x * 10;
        document.getElementById('calibration-x-value').textContent = x.toFixed(1);
      }
      if (savedY !== null) {
        const y = parseFloat(savedY);
        document.getElementById('calibration-y').value = y * 10;
        document.getElementById('calibration-y-value').textContent = y.toFixed(1);
      }
    });
  </script>

  <script>
    (function () {
      const panel = {
        initialized: false,
        waiting: false,
        init() {
          if (this.initialized) return;
          const controller = window.markerInteractionController;
          if (!controller) {
            if (!this.waiting) {
              this.waiting = true;
              setTimeout(() => {
                this.waiting = false;
                this.init();
              }, 200);
            }
            return;
          }

          this.initialized = true;
          this.controller = controller;
          this.typeSelect = document.getElementById('dev-chart-type');
          this.xSelect = document.getElementById('dev-x-axis');
          this.ySelect = document.getElementById('dev-y-axis');
          this.sortColumnSelect = document.getElementById('dev-sort-column');
          this.sortOrderSelect = document.getElementById('dev-sort-order');
          this.filterColumnSelect = document.getElementById('dev-filter-column');
          this.filterValueSelect = document.getElementById('dev-filter-value');
          this.refreshBtn = document.getElementById('dev-refresh-columns');
          this.resetBtn = document.getElementById('dev-reset-config');
          this.chartStateEl = document.getElementById('dev-state-chart');
          this.xStateEl = document.getElementById('dev-state-x');
          this.yStateEl = document.getElementById('dev-state-y');
          this.sortStateEl = document.getElementById('dev-state-sort');
          this.sortOrderStateEl = document.getElementById('dev-state-order');
          this.filterColumnStateEl = document.getElementById('dev-state-filter-column');
          this.filterValueStateEl = document.getElementById('dev-state-filter-value');

          if (this.typeSelect) {
            this.typeSelect.addEventListener('change', () => {
              this.controller.setChartType(this.typeSelect.value);
            });
          }

          if (this.xSelect) {
            this.xSelect.addEventListener('change', () => {
              if (this.xSelect.value) {
                this.controller.setXAxisColumn(this.xSelect.value);
              }
            });
          }

          if (this.ySelect) {
            this.ySelect.addEventListener('change', () => {
              if (this.ySelect.value) {
                this.controller.setYAxisColumn(this.ySelect.value);
              }
            });
          }

          if (this.sortColumnSelect) {
            this.sortColumnSelect.addEventListener('change', () => {
              if (this.sortColumnSelect.value) {
                this.controller.setSortColumn(this.sortColumnSelect.value);
              }
            });
          }

          if (this.sortOrderSelect) {
            this.sortOrderSelect.addEventListener('change', () => {
              this.controller.setSortOrder(this.sortOrderSelect.value || 'ascending');
            });
          }

          if (this.filterColumnSelect) {
            this.filterColumnSelect.addEventListener('change', () => {
              const selected = this.filterColumnSelect.value;
              this.controller.setFilterColumn(selected || null);
              this.populateFilterValues(selected || null, null);
            });
          }

          if (this.filterValueSelect) {
            this.filterValueSelect.addEventListener('change', () => {
              this.controller.setFilterValue(this.filterValueSelect.value);
            });
          }

          if (this.refreshBtn) {
            this.refreshBtn.addEventListener('click', () => {
              this.controller.refreshAvailableColumns();
              if (typeof this.controller.getStateSnapshot === 'function') {
                this.applyState(this.controller.getStateSnapshot());
              }
            });
          }

          if (this.resetBtn) {
            this.resetBtn.addEventListener('click', () => {
              if (typeof this.controller.resetConfiguration === 'function') {
                this.controller.resetConfiguration();
              }
            });
          }

          if (typeof this.controller.getStateSnapshot === 'function') {
            this.applyState(this.controller.getStateSnapshot());
          }
        },
        populateColumns(columns) {
          const list = Array.isArray(columns) ? columns : [];
          const selects = [
            { element: this.xSelect, fallbackIndex: 0 },
            { element: this.ySelect, fallbackIndex: 1 },
            { element: this.sortColumnSelect, fallbackIndex: 0 }
          ];

          selects.forEach(({ element, fallbackIndex }) => {
            if (!element) return;
            const previous = element.value;
            element.innerHTML = '';

            if (!list.length) {
              const opt = document.createElement('option');
              opt.value = '';
              opt.textContent = 'No columns available';
              element.appendChild(opt);
              element.disabled = true;
              return;
            }

            element.disabled = false;
            list.forEach((column) => {
              const option = document.createElement('option');
              option.value = column;
              option.textContent = column;
              element.appendChild(option);
            });

            if (previous && list.includes(previous)) {
              element.value = previous;
            } else if (list[fallbackIndex]) {
              element.value = list[fallbackIndex];
            } else {
              element.value = list[0];
            }
          });

          if (this.filterColumnSelect) {
            const previous = this.filterColumnSelect.value;
            this.filterColumnSelect.innerHTML = '';

            const noneOption = document.createElement('option');
            noneOption.value = '';
            noneOption.textContent = 'No filter';
            this.filterColumnSelect.appendChild(noneOption);

            if (!list.length) {
              const placeholder = document.createElement('option');
              placeholder.value = '';
              placeholder.textContent = 'No columns available';
              placeholder.disabled = true;
              this.filterColumnSelect.appendChild(placeholder);
              this.filterColumnSelect.disabled = true;
              this.filterColumnSelect.value = '';
              return;
            }

            this.filterColumnSelect.disabled = false;
            list.forEach((column) => {
              const option = document.createElement('option');
              option.value = column;
              option.textContent = column;
              this.filterColumnSelect.appendChild(option);
            });

            if (previous && list.includes(previous)) {
              this.filterColumnSelect.value = previous;
            } else {
              this.filterColumnSelect.value = '';
            }
          }
        },
        hasOption(select, value) {
          if (!select) return false;
          const normalized = value === undefined || value === null ? '' : String(value);
          return Array.from(select.options).some((option) => option.value === normalized);
        },
        populateFilterValues(column, selectedValue) {
          if (!this.filterValueSelect) {
            return;
          }

          const select = this.filterValueSelect;
          select.innerHTML = '';

          if (!column) {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select a column first';
            select.appendChild(placeholder);
            select.disabled = true;
            select.value = '';
            return;
          }

          const values = typeof this.controller?.getFilterValuesForColumn === 'function'
            ? this.controller.getFilterValuesForColumn(column)
            : [];

          select.disabled = false;

          const allOption = document.createElement('option');
          allOption.value = '';
          allOption.textContent = 'All values';
          select.appendChild(allOption);

          if (!values.length) {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'No values found';
            placeholder.disabled = true;
            select.appendChild(placeholder);
            select.value = '';
            return;
          }

          values.forEach((value) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            select.appendChild(option);
          });

          const normalized = selectedValue === undefined || selectedValue === null ? '' : String(selectedValue);
          if (this.hasOption(select, normalized)) {
            select.value = normalized;
          } else {
            select.value = '';
          }
        },
        applyState(state = {}) {
          if (!this.initialized) return;

          const columns = Array.isArray(state.availableColumns) ? state.availableColumns : [];
          this.populateColumns(columns);

          if (this.typeSelect && state.chartType) {
            if (!this.hasOption(this.typeSelect, state.chartType)) {
              const option = document.createElement('option');
              option.value = state.chartType;
              option.textContent = state.chartType;
              this.typeSelect.appendChild(option);
            }
            this.typeSelect.value = state.chartType;
          }

          if (this.xSelect && this.hasOption(this.xSelect, state.xColumn)) {
            this.xSelect.value = state.xColumn;
          }

          if (this.ySelect && this.hasOption(this.ySelect, state.yColumn)) {
            this.ySelect.value = state.yColumn;
          }

          if (this.sortColumnSelect) {
            if (this.hasOption(this.sortColumnSelect, state.sortColumn)) {
              this.sortColumnSelect.value = state.sortColumn;
            } else if (!this.sortColumnSelect.value && this.sortColumnSelect.options.length) {
              this.sortColumnSelect.value = this.sortColumnSelect.options[0].value;
            }
          }

          if (this.sortOrderSelect) {
            this.sortOrderSelect.value = state.sortOrder || 'ascending';
          }

          if (this.filterColumnSelect) {
            const targetColumn = state.filterColumn || '';
            if (this.hasOption(this.filterColumnSelect, targetColumn)) {
              this.filterColumnSelect.value = targetColumn;
            } else {
              this.filterColumnSelect.value = '';
            }
          }

          this.populateFilterValues(state.filterColumn || null, state.filterValue ?? null);

          if (this.chartStateEl) {
            this.chartStateEl.textContent = state.chartType || '-';
          }
          if (this.xStateEl) {
            this.xStateEl.textContent = state.xColumn || '-';
          }
          if (this.yStateEl) {
            this.yStateEl.textContent = state.yColumn || '-';
          }
          if (this.sortStateEl) {
            this.sortStateEl.textContent = state.sortColumn || '-';
          }
          if (this.sortOrderStateEl) {
            const label = state.sortOrder || 'ascending';
            this.sortOrderStateEl.textContent = label.charAt(0).toUpperCase() + label.slice(1);
          }
          if (this.filterColumnStateEl) {
            this.filterColumnStateEl.textContent = state.filterColumn || '-';
          }
          if (this.filterValueStateEl) {
            const display = state.filterValue === undefined || state.filterValue === null || state.filterValue === ''
              ? 'All values'
              : state.filterValue;
            this.filterValueStateEl.textContent = display;
          }
        }
      };

      window.MarkerTestPanel = panel;

      window.addEventListener('markerInteractionStateChange', (event) => {
        panel.init();
        if (panel.initialized) {
          panel.applyState(event.detail || {});
        }
      });

      window.addEventListener('load', () => {
        setTimeout(() => panel.init(), 300);
      });
    })();
  </script>

  <script>
    (function () {
      const refs = {
        x: document.getElementById('state-x-axis'),
        y: document.getElementById('state-y-axis'),
        sortColumn: document.getElementById('state-sort-column'),
        sortOrder: document.getElementById('state-sort-order'),
        filter: document.getElementById('state-filter'),
        chartType: document.getElementById('state-chart-type'),
        columns: document.getElementById('state-columns')
      };

      if (!refs.x) {
        return;
      }

      const capitalize = (value) => {
        if (!value || typeof value !== 'string') return '-';
        return value.charAt(0).toUpperCase() + value.slice(1);
      };

      const update = (detail = {}) => {
        refs.x.textContent = detail.xColumn || '-';
        refs.y.textContent = detail.yColumn || '-';
        refs.sortColumn.textContent = detail.sortColumn || '-';
        refs.sortOrder.textContent = detail.sortOrder ? capitalize(detail.sortOrder) : '-';

        if (detail.filterColumn && detail.filterValue !== null && detail.filterValue !== undefined && detail.filterValue !== '') {
          refs.filter.textContent = `${detail.filterColumn} = ${detail.filterValue}`;
        } else if (detail.filterColumn) {
          refs.filter.textContent = `${detail.filterColumn} (All values)`;
        } else {
          refs.filter.textContent = '-';
        }

        refs.chartType.textContent = detail.chartType ? capitalize(detail.chartType) : '-';
        refs.columns.textContent = Array.isArray(detail.availableColumns) && detail.availableColumns.length
          ? detail.availableColumns.join(', ')
          : 'None';
      };

      window.addEventListener('markerInteractionStateChange', (event) => {
        update(event?.detail || {});
      });

      update({});
    })();
  </script>

  <!-- AR JavaScript modules -->
  <script src="../src/ar/coordinate-system.js"></script>
  <script src="../src/ar/gesture-detector.js"></script>
  <script src="../src/ar/chart-manager.js"></script>
  <script src="../src/ar/hand-tracking.js"></script>
  <script src="../src/ar/marker-interaction-controller.js"></script>
  <script src="../src/ar/hybrid-ar-controller.js"></script>
</body>

</html>
